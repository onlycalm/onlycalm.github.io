<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>参数有效性检验 | OnlyCalm's Blog</title><meta name="author" content="OnlyCalm"><meta name="copyright" content="OnlyCalm"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="参数有效性检验前言：&amp;amp;emsp;&amp;amp;emsp;2018-11-26天气凉，耗时三个周末完成这篇原创文章，记录下自己关于程序安全性方面的一些微薄见解。愿自己程序员之路越走越顺利，保持激情初心，不忘理想前行。 1 问题： 为什么要检验？ 哪些情况判为参数失效？ 有哪些参数需要检验？ 怎么检"><link rel="shortcut icon" href="http://onlycalm.gitee.io/blogimage/res/favicon_16x16.ico"><link rel="canonical" href="http://onlycalm.cn/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?aa84fe0b630e04119afd5cc009c11181";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '参数有效性检验',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-08-09 15:10:00'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/butterfly.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/res/Avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">229</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">327</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">53</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fab fa-fort-awesome"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book-open"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-box-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-bookmark"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-hourglass-half"></i><span> 时间轴</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-icons"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-headphones"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-user-friends"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/reward/"><i class="fa-fw fas fa-gift"></i><span> 打赏</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fab fa-canadian-maple-leaf"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://onlycalm.gitee.io/blogimage/res/Cover_10.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="OnlyCalm's Blog"><span class="site-name">OnlyCalm's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fab fa-fort-awesome"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book-open"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-box-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-bookmark"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-hourglass-half"></i><span> 时间轴</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-icons"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-headphones"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-user-friends"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/reward/"><i class="fa-fw fas fa-gift"></i><span> 打赏</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fab fa-canadian-maple-leaf"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">参数有效性检验</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-11-26T15:55:29.000Z" title="发表于 2018-11-26 23:55:29">2018-11-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-09T07:10:00.000Z" title="更新于 2020-08-09 15:10:00">2020-08-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/">编程思想</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">28k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>103分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="参数有效性检验"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="参数有效性检验"><a href="#参数有效性检验" class="headerlink" title="参数有效性检验"></a><center>参数有效性检验</center></h1><p><em>前言：</em><br>&amp;emsp;&amp;emsp;<em>2018-11-26天气凉，耗时三个周末完成这篇原创文章，记录下自己关于程序安全性方面的一些微薄见解。愿自己程序员之路越走越顺利，保持激情初心，不忘理想前行。</em></p>
<h2 id="1-问题："><a href="#1-问题：" class="headerlink" title="1 问题："></a>1 问题：</h2><ul>
<li>为什么要检验？</li>
<li>哪些情况判为参数失效？</li>
<li>有哪些参数需要检验？</li>
<li>怎么检测？</li>
<li>在哪里检验？</li>
<li>怎么处理？</li>
</ul>
<h2 id="2-为什么要检验？"><a href="#2-为什么要检验？" class="headerlink" title="2 为什么要检验？"></a>2 为什么要检验？</h2><p>&amp;emsp;&amp;emsp;保护程序免糟非法输入数据的破坏，尽可能将异常数据对程序造成的影响控制在有限的范围内。<br>&amp;emsp;&amp;emsp;防御式编程主要思想：子程序应该不因传入错误数据而被破坏，哪怕是由其他子程序产生的错误数据。更一般地说，其核心思想是承认程序都会有问题，都需要被修改，聪明的程序员应该根据这一点来编程。<br>&amp;emsp;&amp;emsp;不管进来什么，好的程序都不会生成垃圾，而是做到“垃圾进，什么都不出”、“进来垃圾，出去是错误提示”或“不许垃圾进来”。</p>
<p align="right">——《代码大全2》第8章 防御式编程</p>

<h2 id="3-哪些情况判为参数失效？"><a href="#3-哪些情况判为参数失效？" class="headerlink" title="3 哪些情况判为参数失效？"></a>3 哪些情况判为参数失效？</h2><ul>
<li>参数越界失效：参数值不在预期范围内。比如参数值超过上下限，数组下标越界。</li>
<li>符号异常失效：指正负号异常，应该尽可能使用无符号类型。</li>
<li>空指针失效：传递空指针。</li>
<li>数据过期失效：原本实时更新的数据长期未变化。</li>
<li>跳变失效：数据波动异常的大或小。</li>
<li>关联数据异常失效：指两个以上的数据值之间有依赖和关联，当值不符合依赖关联性时认为失效。</li>
</ul>
<h2 id="4-有哪些参数需要检验？"><a href="#4-有哪些参数需要检验？" class="headerlink" title="4 有哪些参数需要检验？"></a>4 有哪些参数需要检验？</h2><p>&amp;emsp;&amp;emsp;最佳的形式是在一开始就不引入错误。</p>
<ul>
<li>从数据来源讲：<ul>
<li>检查来源于外部的数据的值。</li>
<li>检查子程序的输入参数的值。</li>
</ul>
</li>
</ul>
<p>&amp;emsp;&amp;emsp;应重点检查外部输入数据（网络通讯传入、上层或下层传入、硬件设备采集数据）外部传入的数据对本模块的程序员来说往往是模糊和不可操控的，内部数据也较多依赖于外部输入数据，因此重点检查外部数据。内部数据可以只检查较为复杂的算式或算法结果。</p>
<h2 id="5-怎么检测？"><a href="#5-怎么检测？" class="headerlink" title="5 怎么检测？"></a>5 怎么检测？</h2><p>&amp;emsp;&amp;emsp;对参数进行失效检验意味着需要存储有一些有关参数的信息，可以定义结构体化的参数。我们对参数进行分类如下：</p>
<h3 id="5-1-功能型参数"><a href="#5-1-功能型参数" class="headerlink" title="5.1 功能型参数"></a>5.1 功能型参数</h3><p>&amp;emsp;&amp;emsp;用于表示某项功能开关的参数，我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Type redefinition------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Function enum definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Switch</span> &#123;</span>DISABLE, ENABLE&#125; ESwitch; <span class="comment">//Switch variable</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Functional parameter structure-----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FunParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ESwitch eSwitch;               <span class="comment">//Value: ENABLE or DISABLE</span></span><br><span class="line">    ESwitch ePrevious;             <span class="comment">//Previous value</span></span><br><span class="line">    Word wCounter;                 <span class="comment">//Enable or Disable time</span></span><br><span class="line">&#125;TFunParameter, * pTFunParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//functional parameter initialization------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor head temperature</span></span><br><span class="line">TFunParameter tfHeadTemp = &#123;.eSwitch = ENABLE,</span><br><span class="line">                            .ePrevious = DISABLE,</span><br><span class="line">                            .wCounter = <span class="number">0</span></span><br><span class="line">                            &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测功能开关状态切换的跳变变化。功能有时需要记录开启或者关闭时间，因此直接将定时器封装进结构体使得参数关系紧密。</em></p>
<p>&amp;emsp;&amp;emsp;对功能型参数使用枚举类型因此不需要检测值越界失效和符号异常失效，重要的是检测关联数据异常失效。比如功能A和B为互斥关系，一次只能有一个功能打开或两个功能都关闭，再比如功能B开启前应该先打开功能A。功能开关较多，关联性强的情况下这样的检测变得重要。<br>&amp;emsp;&amp;emsp;对于功能型参数的关联性检测可以放到预处理时期由编译器检测，不用等到外出调试才发现错误。预处理指令不能检测变量，考虑到功能有效性一旦确当后不在修改，但又要满足调试时可能存在的对功能开关的修改，可以通过以下形式实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//General macro definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ENABLE                    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISABLE                   0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//The switch of Function-------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_HEAD_TEMP             ENABLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_OIL_PRESS             DISABLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_HEAD_TEMP_STOP        ENABLE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Functional correlation detection---------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span>((FUN_HEAD_TEMP == FUN_OIL_PRESS) &amp;&amp; (FUN_HEAD_TEMP == ENABLE))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">error</span> 油压与油温为互斥功能,不能同时开启。</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span>((FUN_HEAD_TEMP_STOP == ENABLE) &amp;&amp; (FUN_HEAD_TEMP == DISABLE))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">error</span> 开启油温停机功能必须同时开启油温采样功能。</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//functional parameter initialization--------------------------------------------------------</span></span><br><span class="line">TFunParameter tfHeadTemp = &#123;.eSwitch = FUN_HEAD_TEMP, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;              <span class="comment">//Motor head temperature</span></span><br><span class="line">TFunParameter tfOilPress = &#123;.eSwitch = FUN_OIL_PRESS, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;              <span class="comment">//Oile press Function</span></span><br><span class="line">TFunParameter tfHeadTempStop = &#123;.eSwitch = FUN_HEAD_TEMP_STOP, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;     <span class="comment">//Motor Closed Function</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-状态型参数"><a href="#5-2-状态型参数" class="headerlink" title="5.2 状态型参数"></a>5.2 状态型参数</h3><p>&amp;emsp;&amp;emsp;状态型参数用于表示当前运行下的某种状态，是实时的因此不像常量宏可以用预处理指令检验。比如电机的开关波状态，阀门的开关状态，气压状态等。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Status enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">MotorPwm</span>&#123;</span>PWM_CLOSE, PWM_OPEN&#125;EMotorPwm;                 <span class="comment">//Motor Pwm Status</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">AirPressure</span>&#123;</span>AP_LOW, AP_NORMAL, AP_HIGH&#125;EAirPressure;    <span class="comment">//Air Pressure Status</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Status parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">StatusParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Byte byStatus;                           <span class="comment">//Current Status</span></span><br><span class="line">    Byte byPrevious;                         <span class="comment">//Previous value</span></span><br><span class="line">    Byte byFrequency;                        <span class="comment">//Status frequency</span></span><br><span class="line">    Word wCounter;                           <span class="comment">//Status duration time</span></span><br><span class="line">&#125;TStatusParameter, * pTStatusParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Status parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor Pwm Status</span></span><br><span class="line">TStatusParameter tsMotorPwm = &#123;.byStatus = PWM_OPEN,</span><br><span class="line">                                .byPrevious = PWM_CLOSE,</span><br><span class="line">                                .byFrequency = <span class="number">0</span>,</span><br><span class="line">                                .wCounter = <span class="number">0</span>                        <span class="comment">//Unit: s</span></span><br><span class="line">                                &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Air Pressure Status</span></span><br><span class="line">TStatusParameter tsAirPressure = &#123;.byStatus = AP_NORMAL,</span><br><span class="line">                                    .byPrevious = AP_NORMAL,</span><br><span class="line">                                    .byFrequency = <span class="number">0</span>,</span><br><span class="line">                                    .wCounter = <span class="number">0</span>                    <span class="comment">//Unit: ms</span></span><br><span class="line">                                    &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测状态转换的跳变变化。状态常常需要记录持续的时间，因此加入一个计数器可用于计时。在一段时间内有时还需要记录状态发生的次数，因此需要一个变量记录状态发生频度。</em></p>
<p>&amp;emsp;&amp;emsp;一种运行状态可能存在两种以上的状态值，且不同的状态值有不同的含义，因此无法用统一的枚举类型。对于一组状态值可以单独使用一组枚举表示，枚举的参数封装性更好，宏定义参数较“散”但省空间，综合多种因素在状态繁多的情况下我选择用封装性更好的枚举。<br>&amp;emsp;&amp;emsp;对于状态的检测，由于状态是随着程序运行实时变化的且不固定，因此无法在编译阶段对状态值的有效性检测。这就需要我们根据实际逻辑需要增加相应的检测代码。由于状态值都通过枚举定义好，因此不需要做参数越界失效和符号异常失效判断，状态值都是预知且固定的所以不需要跳变失效判断，其他失效根据实际情况添加检验代码。</p>
<h3 id="5-3-故障型参数。"><a href="#5-3-故障型参数。" class="headerlink" title="5.3 故障型参数。"></a>5.3 故障型参数。</h3><p>&amp;emsp;&amp;emsp;故障型参数用于记录当前或历史的故障发生情况，并决定是否要发出报警信号或停机等操作。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Unusual enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">UnusualSymbol</span>&#123;</span>ABNORMAL, NORMAL&#125;EUnusualSymbol;        <span class="comment">//Unusual state</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Unusual parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">UnusualParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    EUnusualSymbol eUnusualSymbol;                <span class="comment">//Unusual symbol</span></span><br><span class="line">    EUnusualSymbol ePrevious;                     <span class="comment">//Previous value</span></span><br><span class="line">    EUnusualSymbol eWarningSymbol;                <span class="comment">//Unusual Warning symbol</span></span><br><span class="line">    Byte byFrequency;                             <span class="comment">//Unusual frequency</span></span><br><span class="line">    Word wCounter;                                <span class="comment">//Unusual duration time</span></span><br><span class="line">&#125;TUnusualParameter, * pTUnusualParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Unusual parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Head temperature over</span></span><br><span class="line">TUnusualParameter tuHeadTempOver = &#123;.eUnusualSymbol   = NORMAL,</span><br><span class="line">                                    .ePrevious        = NORMAL,</span><br><span class="line">                                    .eWarningSymbol   = NORMAL,</span><br><span class="line">                                    .byFrequency      = <span class="number">0</span>,</span><br><span class="line">                                    .wCounter         = <span class="number">0</span>         <span class="comment">//Unit: ms</span></span><br><span class="line">                                    &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测故障的发生和恢复变化。对于故障常常需要检测故障的持续时间和频度，因此定义相关成员变量。根据故障的持续时间和频度有时会引起其他动作，比如报警或停机，因此引入报警标志。</em></p>
<p>&amp;emsp;&amp;emsp;故障的状态只需要两种，即异常或正常，因此可以同意定义枚举类型。<br>&amp;emsp;&amp;emsp;对于故障的检测，由于故障是在程序运行中发生，因此对故障参数有效性的检测需要实时进行。由于故障参数有固定的枚举类型，因此不需要越界失效、符号异常、跳变失效判断，其他失效根据实际情况添加检验代码。</p>
<h3 id="5-4-普通值参数。"><a href="#5-4-普通值参数。" class="headerlink" title="5.4 普通值参数。"></a>5.4 普通值参数。</h3><p>&amp;emsp;&amp;emsp;普通值参数是较为庞大的一类参数，这类参数的值类型不一，值之间的关联性可以很复杂，每种值各有特点，参数的有效性检验很难做统一的处理。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Sign enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Sign</span>&#123;</span>SIGN_MINUS = <span class="number">-1</span>, SIGN_PLUS = <span class="number">1</span>&#125;ESign;          <span class="comment">//Unusual state</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Lock</span>&#123;</span>LOCK_UNLOCK = <span class="number">0</span>, LOCK_LOCK = <span class="number">1</span>&#125;ELock;          <span class="comment">//Resource lock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Value parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ValueParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ESign eSign;                                <span class="comment">//Value: SIGN_PLUS of SIGN_MINUS</span></span><br><span class="line">    Word wValue;                                <span class="comment">//Current value</span></span><br><span class="line">    Word wPrevious;                             <span class="comment">//Previous value</span></span><br><span class="line">    Word wDefault;                              <span class="comment">//Default value</span></span><br><span class="line">    Word wCounter;                              <span class="comment">//duration time</span></span><br><span class="line">    Word wUpperLimit;                           <span class="comment">//Upper limit</span></span><br><span class="line">    Word wLowerLimit;                           <span class="comment">//Lower limit</span></span><br><span class="line">    Word wJumpLimit;                            <span class="comment">//Jump limit</span></span><br><span class="line">    Word wOverdueLimit;                         <span class="comment">//Overdue limit</span></span><br><span class="line">    Byte wLock;                                 <span class="comment">//Resource lock</span></span><br><span class="line">&#125;TValueParameter, * pTValueParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Value parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor Rpm</span></span><br><span class="line">TValueParameter tvMotorActualRpm = &#123;.eSign         = SIGN_PLUS,</span><br><span class="line">                                    .wValue        = <span class="number">0</span>,                <span class="comment">//Unit: Rpm</span></span><br><span class="line">                                    .wPrevious     = <span class="number">0</span>,</span><br><span class="line">                                    .wDefault      = <span class="number">1000</span>,</span><br><span class="line">                                    .wCounter      = <span class="number">0</span>,                <span class="comment">//Unit: ms</span></span><br><span class="line">                                    .wUpperLimit   = <span class="number">2000</span>,</span><br><span class="line">                                    .wLowerLimit   = <span class="number">0</span>,</span><br><span class="line">                                    .wJumpLimit    = <span class="number">1000</span>,</span><br><span class="line">                                    .wOverdueLimit = <span class="number">0</span>,                <span class="comment">//Unit: s</span></span><br><span class="line">                                    .wLock           = LOCK_UNLOCK</span><br><span class="line">                                    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Speed</span></span><br><span class="line">TValueParameter tvSpeed = &#123;.eSign         = SIGN_PLUS,</span><br><span class="line">                            .wValue        = <span class="number">0</span>,                <span class="comment">//Unit: 0.1K/M</span></span><br><span class="line">                            .wPrevious     = <span class="number">0</span>,</span><br><span class="line">                            .wDefault      = <span class="number">400</span>,</span><br><span class="line">                            .wCounter      = <span class="number">0</span>,                <span class="comment">//Unit: ms</span></span><br><span class="line">                            .wUpperLimit   = <span class="number">200</span>,</span><br><span class="line">                            .wLowerLimit   = <span class="number">0</span>,</span><br><span class="line">                            .wJumpLimit    = <span class="number">1000</span>,</span><br><span class="line">                            .wOverdueLimit = <span class="number">0</span>,                <span class="comment">//Unit: s</span></span><br><span class="line">                            .wLock          = LOCK_UNLOCK</span><br><span class="line">                            &#125;;</span><br></pre></td></tr></table></figure>

<h2 id="6-怎么处理？"><a href="#6-怎么处理？" class="headerlink" title="6 怎么处理？"></a>6 怎么处理？</h2><h3 id="6-1-用断言检查永远不应该发生的错误"><a href="#6-1-用断言检查永远不应该发生的错误" class="headerlink" title="6.1 用断言检查永远不应该发生的错误"></a>6.1 用断言检查永远不应该发生的错误</h3><p>&amp;emsp;&amp;emsp;优点：错误定位，给代码调试带来极大的便利，创建更稳定、质量更好且不易于出错的代码。<br>&amp;emsp;&amp;emsp;缺点：频繁的调用会极大的影响程序的性能，增加额外的开销。<br>&amp;emsp;&amp;emsp;相比于函数，调用函数需要额外的队栈开销，宏函数节省开销但同一段代码存在多个副本。使用宏函数会引起很多副作用需要小心。<br>&amp;emsp;&amp;emsp;断言使用形式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#define NDEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _assert(bExpression)                                 \</span></span><br><span class="line"><span class="meta">do&#123;                                                          \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!(bExpression))                                  \</span></span><br><span class="line"><span class="meta">        &#123;                                                    \</span></span><br><span class="line"><span class="meta">            ErrorDeal();            <span class="comment">/*Error deal*/</span>           \</span></span><br><span class="line"><span class="meta">        &#125;                                                    \</span></span><br><span class="line"><span class="meta">&#125;while(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _assert(bExpression)        ((void)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    Byte byNumber1 = <span class="number">10</span>;</span><br><span class="line">    Byte byNumber2 = <span class="number">0</span>;</span><br><span class="line">    Byte byResult  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    _assert(<span class="number">0</span> != byNumber2);        <span class="comment">//Cannot be 0</span></span><br><span class="line"></span><br><span class="line">    byResult = byNumber1 / byNumber2;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, byNumber2);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:通过定义宏NDEBUG来控制断言的开启或关断。用于对较为严重的错误统一处理。另外，禁止把必须执行的代码放在断言中，断言关闭后功能将失效。</em><br>&amp;emsp;&amp;emsp;用断言的两种形式：</p>
<ul>
<li>断言一直开启。不论是调试版还是发行版都将断言函数开启。</li>
<li>可以在测试时启用断言，而在部署时禁用断言。同样，程序投入运行后，最终用户在遇到问题时可以重新起用断言。它可以快速发现并定位软件问题，同时对系统错误进行自动报警。断言可以对在系统中隐藏很深，用其它手段极难发现的问题可以用断言来进行定位，从而缩短软件问题定位时间，提高系统的可测性。实际应用时，可根据具体情况灵活地设计断言。</li>
</ul>
<blockquote>
<ul>
<li>前置条件断言：代码执行之前必须具备的特性。</li>
<li>后置条件断言：代码执行之后必须具备的特性。</li>
<li>前后不变断言：代码执行前后不能变化的特性。</li>
</ul>
</blockquote>
<h3 id="6-2-错误处理代码"><a href="#6-2-错误处理代码" class="headerlink" title="6.2 错误处理代码"></a>6.2 错误处理代码</h3><p>&amp;emsp;&amp;emsp;用错误处理代码来处理预期会发生的状况，用断言来处理绝不应该发生的状况。通常用错误处理来检查有害的输入数据。断言检查代码中的bug。<br>&amp;emsp;&amp;emsp;根据情形的不同，你可以返回中立值、换用下一个正确数据、返回与前次相同的值、换用最接近的有效值、在日志文件中记录警告信息、返回一个错误吗、调用错误处理子程序或对象、显示出错信息或者关闭程序——或把这些技术结合起来使用。</p>
<h4 id="6-2-1-返回中立值"><a href="#6-2-1-返回中立值" class="headerlink" title="6.2.1 返回中立值"></a>6.2.1 返回中立值</h4><p>&amp;emsp;&amp;emsp;对于一些“危害”并不严重的错误，最佳的做法就是继续执行操作并简单的返回一个没有危害的数值，比如数值0或空指针。</p>
<h4 id="6-2-2-给出一个修正的数据"><a href="#6-2-2-给出一个修正的数据" class="headerlink" title="6.2.2 给出一个修正的数据"></a>6.2.2 给出一个修正的数据</h4><p>&amp;emsp;&amp;emsp;对于can网络中不断更新但实时性要求并不高的数据，比如电机温度，短时间内数据丢失可是使用历史值。</p>
<h4 id="6-2-3-换用最接近的合法值"><a href="#6-2-3-换用最接近的合法值" class="headerlink" title="6.2.3 换用最接近的合法值"></a>6.2.3 换用最接近的合法值</h4><p>&amp;emsp;&amp;emsp;有些情况下可以换用最接近的合法值，当值大于上限或者小于下限值时，可以直接去上下限边界值。</p>
<h4 id="6-2-4-把警告信息记录到日志文件中"><a href="#6-2-4-把警告信息记录到日志文件中" class="headerlink" title="6.2.4 把警告信息记录到日志文件中"></a>6.2.4 把警告信息记录到日志文件中</h4><p>&amp;emsp;&amp;emsp;在检测到错误数据的时候，你可以选择在日志文件中记录一条警告信息，然后继续执行。这种方法可以同其他的错误处理技术结合使用。</p>
<h4 id="6-2-5-返回一个错误码"><a href="#6-2-5-返回一个错误码" class="headerlink" title="6.2.5 返回一个错误码"></a>6.2.5 返回一个错误码</h4><p>&amp;emsp;&amp;emsp;你可以决定只让系统的某些部分处理错误。其他部分则不在本地（局部）处理错误，而只是简单地报告有错误发生和发生的是何种错误，并信任调用链上游的某个子程序会处理该错误。通知系统其余部分已经发生错误可以采用下列方法：</p>
<blockquote>
<ul>
<li>设置一个状态变量的值。</li>
<li>用状态值作为函数的返回值。</li>
<li>用语言内建的异常机制抛出一个异常。</li>
</ul>
</blockquote>
<p>&amp;emsp;&amp;emsp;需要决定系统里哪部分应该直接处理错误，哪部分只是报告所发生的错误。对于安全性很重要的部分请确认调用的子程序总会检查返回的错误码。</p>
<h4 id="6-2-6-调用错误处理子程序或对象"><a href="#6-2-6-调用错误处理子程序或对象" class="headerlink" title="6.2.6 调用错误处理子程序或对象"></a>6.2.6 调用错误处理子程序或对象</h4><p>&amp;emsp;&amp;emsp;这种方法需要把错误处理都集中在一个全局的错误处理子程序或对象中，使得调试工作更为简单。而代价是整个程序都要知道这个集中点并与之紧密耦合。如果你想在其他系统中重用其中的某些代码，那就得把错误处理代码一并带过去。</p>
<h4 id="6-2-7-错误发生时发出错误信息"><a href="#6-2-7-错误发生时发出错误信息" class="headerlink" title="6.2.7 错误发生时发出错误信息"></a>6.2.7 错误发生时发出错误信息</h4><p>&amp;emsp;&amp;emsp;在调试模式下，当错误发生时为了帮助调试者尽快定位问题所在位置，可以通过打印显示或者报文将错误信息较为详细的发出。</p>
<h4 id="6-2-8-在局部处理错误"><a href="#6-2-8-在局部处理错误" class="headerlink" title="6.2.8 在局部处理错误"></a>6.2.8 在局部处理错误</h4><p>&amp;emsp;&amp;emsp;针对一些设计方案可能更适合在局部立即解决所有遇到的问题，具体的错误处理方法需要由该模块的设计者根据问题特点自行决定。这种方法给力模块程序员很大的灵活度，但这样做会导致错误记录和发出错误信息等代码散布到整个系统中，从而使得设计者还得考虑错误记录和错误发送相关的故障问题。能在局部立即解决的问题最好在内部立即解决。</p>
<h4 id="6-2-9-关闭或复位程序"><a href="#6-2-9-关闭或复位程序" class="headerlink" title="6.2.9 关闭或复位程序"></a>6.2.9 关闭或复位程序</h4><p>&amp;emsp;&amp;emsp;程序发生较为严重的错误时，比如堆栈溢出导致运行环境被破坏，所依附的操作系统严重故障，甚至收到恶意攻击时可能需要关闭和复位程序。<br>&amp;emsp;&amp;emsp;确定一种通用的处理错误参数的方法，是架构层次（或称高层次）的设计决策。如果在高层次处理错误，低层次只是汇报错误，那么就要确保高层次真的处理有错误！千万不要忽略错误信息，在函数的返回值返回故障信息，记得检查函数的返回值，即使你对某个函数有足够的自信。当有错误产生时，请记录并反馈对应的故障码和它描述的信息。</p>
<h3 id="6-3-异常"><a href="#6-3-异常" class="headerlink" title="6.3 异常"></a>6.3 异常</h3><p>&amp;emsp;&amp;emsp;如果一个子程序在运行过程中遇到了预料之外的情况，但这个情况又必须处理否则会影响功能的使用或程序的运行，这个时候需要子程序将异常抛出，把“问题”交给能解释并处理好它的代码。这属于一种错误处理机制。<br>&amp;emsp;&amp;emsp;能在局部处理的错误优选在局部处理，不能立即处理或局部无法处理的问题可抛出异常。不能用异常来推卸责任。异常处理函数需要了解大量子程序可能抛出何种错误并给出处理办法，弱化了程序的封装性，增加了程序的复杂程度。<br>&amp;emsp;&amp;emsp;每种异常都对应一种特殊情况，因此要确保异常信息中含有为理解异常抛出原因所需的充分信息，这对于读取异常信息的人来说是很有价值的。比如当发生数据越界时，除了抛出对应的故障码标识数据越界外，还应该给出上下界和非法的数据值。<br>&amp;emsp;&amp;emsp;总结：断言、错误处理代码、异常都需要有完备的故障捕获处理，以及故障信息的记录反馈。因此有必要考虑一种方法以确保异常处理的一致性，即创建一个集中的异常报告机制。这个机制需要能对异常信息进行一个集中的格式化和存储。c语言不像c++和java自带异常机制，但c语言可以借助setjmp和longjmp实现异常处理机制。实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> String        char *              <span class="comment">//Don&#x27;t use typedef</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception information structure-----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Exception</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> * description;</span><br><span class="line">&#125;TException, * pTException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception stack structure------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ExceptionFrame</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ExceptionFrame</span> * <span class="title">prev</span>;</span></span><br><span class="line">    jmp_buf env;                          <span class="comment">//Use in setjmp()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Exception information</span></span><br><span class="line">    <span class="type">const</span> TException * ptException;       <span class="comment">//About Exception</span></span><br><span class="line">    <span class="type">const</span> String strFileName;             <span class="comment">//File name</span></span><br><span class="line">    <span class="type">const</span> String strFunctionName;         <span class="comment">//Function name</span></span><br><span class="line">    Word wLineNumber;                     <span class="comment">//Line number</span></span><br><span class="line">&#125;TExceptionFrame, * pTExceptionFrame;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception status----------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">ExceptionStatus</span>&#123;</span></span><br><span class="line">    EXCEPT_ENTERED = <span class="number">0</span>,</span><br><span class="line">    EXCEPT_RAISED,</span><br><span class="line">    EXCEPT_HANDLED,</span><br><span class="line">    EXCEPT_FINALIZED</span><br><span class="line">&#125;EExceptionStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">*                try-catch-finally definition                *</span></span><br><span class="line"><span class="comment">*************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//try deal--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _try                                                                     \</span></span><br><span class="line"><span class="meta">&#123;                                                                                \</span></span><br><span class="line"><span class="meta">    Byte byExceptFlg;                                    <span class="comment">/*Return by setjmp()*/</span>  \</span></span><br><span class="line"><span class="meta">    TExceptionFrame tExceptionNode;                                              \</span></span><br><span class="line"><span class="meta">                                                                                 \</span></span><br><span class="line"><span class="meta">    <span class="comment">/*Push stack*/</span>                                                               \</span></span><br><span class="line"><span class="meta">    tExceptionNode.prev = ptExceptionStackTop;                                   \</span></span><br><span class="line"><span class="meta">    ptExceptionStackTop = &amp;tExceptionNode;                                       \</span></span><br><span class="line"><span class="meta">                                                                                 \</span></span><br><span class="line"><span class="meta">    byExceptFlg = setjmp(tExceptionNode.env);            <span class="comment">/*Set jump point*/</span>      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                                            \</span></span><br><span class="line"><span class="meta">    &#123;</span></span><br><span class="line">        <span class="comment">/*Here check and throw your exception*/</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//catch deal-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _catch(tException)                                                       \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>        \</span></span><br><span class="line"><span class="meta">        &#123;                                                                        \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span>  \</span></span><br><span class="line"><span class="meta">        &#125;                                                                        \</span></span><br><span class="line"><span class="meta">    &#125;                                                                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> <span class="keyword">if</span>(&amp;(tException) == tExceptionNode.ptException)                         \</span></span><br><span class="line"><span class="meta">    &#123;                                                                            \</span></span><br><span class="line"><span class="meta">        byExceptFlg = EXCEPT_HANDLED;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*Here deal your exception*/</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//finally deal------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _finally                                                                \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span> \</span></span><br><span class="line"><span class="meta">        &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">    &#123;                                                                           \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                                       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            byExceptFlg = EXCEPT_FINALIZED;                                     \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*Here must deal*/</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//end try deal-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _end_try                                                                \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span> \</span></span><br><span class="line"><span class="meta">        &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(EXCEPT_RAISED == byExceptFlg)                                            \</span></span><br><span class="line"><span class="meta">    &#123;                                                                           \</span></span><br><span class="line"><span class="meta">                                                                                \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">&#125;while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//_throw() deal------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _throw(tException) ExceptRaise(&amp;(tException), __FILE__, __FUNCTION__, __LINE__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">*                Exception deal function                     *</span></span><br><span class="line"><span class="comment">*************************************************************/</span></span><br><span class="line">pTExceptionFrame ptExceptionStackTop = <span class="literal">NULL</span>;            <span class="comment">//Stack top</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ExceptRaise</span><span class="params">(<span class="type">const</span> TException * <span class="type">const</span> ptException,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> String <span class="type">const</span> strFileName,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> String <span class="type">const</span> strFunctionN  ame,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> wLineNumber)</span></span><br><span class="line">&#123;</span><br><span class="line">    pTExceptionFrame pStackTop = ptExceptionStackTop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == ptException)                             <span class="comment">//Check NULL exception</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Do Something</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">NULL</span> == pStackTop)                           <span class="comment">//Check stack empty</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Do Something</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Record some information</span></span><br><span class="line">            pStackTop -&gt; ptException = ptException;</span><br><span class="line">            pStackTop -&gt; strFileName = strFileName;</span><br><span class="line">            pStackTop -&gt; strFunctionName = strFunctionName;</span><br><span class="line">            pStackTop -&gt; wLineNumber = wLineNumber;</span><br><span class="line"></span><br><span class="line">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;      <span class="comment">//Pop stack</span></span><br><span class="line"></span><br><span class="line">            longjmp(pStackTop -&gt; env, EXCEPT_RAISED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    TException A = &#123;<span class="string">&quot;A exception&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    _try</span><br><span class="line">    &#123;</span><br><span class="line">        _throw(A);</span><br><span class="line">    &#125;</span><br><span class="line">    _catch(A)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A exception\n&quot;</span>);</span><br><span class="line">    &#125;_end_try;</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&amp;emsp;&amp;emsp;预料之外的错误处理。<br>&amp;emsp;&amp;emsp;异常中没有捕获到的异常情况，我们认为是意外异常，发生意外异常时的一种常见做法是终止程序运行。</p>
<h3 id="6-4-隔栏"><a href="#6-4-隔栏" class="headerlink" title="6.4 隔栏"></a>6.4 隔栏</h3><p>&amp;emsp;&amp;emsp;数据源有两类，一类是外部传入一类是内部运算产生。由于外部数据的处理过程和存储环境对本模块设计者来说是模糊或不可见的，而内部数据处理直接或间接依赖于外部数据。因此我们假定外部数据是肮脏且不可信的，内部数据假定为干净（仅对少量安全性高数据检测）。不可信的外部数据传入内部需要一个统一数据清理的环节，这就是隔栏的作用。<br>&amp;emsp;&amp;emsp;隔栏与断言的关系：<br>&amp;emsp;&amp;emsp;隔栏的使用使断言和错误处理有了清晰的区分。隔栏外部的数据应该使用错误处理技术，在那里对数据做到任何假定都是不安全的。而隔栏内部的程序里就应该使用断言技术，因为传进来的数据都已在通过隔栏时被清理过了。如果隔栏内部的某个子程序检测到了错误的数据，那么应该是程序李的错误而不是数据里的错误。</p>
<p align="right">——《代码大全2》</p>


<h1 id="参数有效性检验-1"><a href="#参数有效性检验-1" class="headerlink" title="参数有效性检验"></a><center>参数有效性检验</center></h1><p><em>前言：</em><br>&amp;emsp;&amp;emsp;<em>2018-11-26天气凉，耗时三个周末完成这篇原创文章，记录下自己关于程序安全性方面的一些微薄见解。愿自己程序员之路越走越顺利，保持激情初心，不忘理想前行。</em></p>
<h2 id="1-问题：-1"><a href="#1-问题：-1" class="headerlink" title="1 问题："></a>1 问题：</h2><ul>
<li>为什么要检验？</li>
<li>哪些情况判为参数失效？</li>
<li>有哪些参数需要检验？</li>
<li>怎么检测？</li>
<li>在哪里检验？</li>
<li>怎么处理？</li>
</ul>
<h2 id="2-为什么要检验？-1"><a href="#2-为什么要检验？-1" class="headerlink" title="2 为什么要检验？"></a>2 为什么要检验？</h2><p>&amp;emsp;&amp;emsp;保护程序免糟非法输入数据的破坏，尽可能将异常数据对程序造成的影响控制在有限的范围内。<br>&amp;emsp;&amp;emsp;防御式编程主要思想：子程序应该不因传入错误数据而被破坏，哪怕是由其他子程序产生的错误数据。更一般地说，其核心思想是承认程序都会有问题，都需要被修改，聪明的程序员应该根据这一点来编程。<br>&amp;emsp;&amp;emsp;不管进来什么，好的程序都不会生成垃圾，而是做到“垃圾进，什么都不出”、“进来垃圾，出去是错误提示”或“不许垃圾进来”。</p>
<p align="right">——《代码大全2》第8章 防御式编程</p>

<h2 id="3-哪些情况判为参数失效？-1"><a href="#3-哪些情况判为参数失效？-1" class="headerlink" title="3 哪些情况判为参数失效？"></a>3 哪些情况判为参数失效？</h2><ul>
<li>参数越界失效：参数值不在预期范围内。比如参数值超过上下限，数组下标越界。</li>
<li>符号异常失效：指正负号异常，应该尽可能使用无符号类型。</li>
<li>空指针失效：传递空指针。</li>
<li>数据过期失效：原本实时更新的数据长期未变化。</li>
<li>跳变失效：数据波动异常的大或小。</li>
<li>关联数据异常失效：指两个以上的数据值之间有依赖和关联，当值不符合依赖关联性时认为失效。</li>
</ul>
<h2 id="4-有哪些参数需要检验？-1"><a href="#4-有哪些参数需要检验？-1" class="headerlink" title="4 有哪些参数需要检验？"></a>4 有哪些参数需要检验？</h2><p>&amp;emsp;&amp;emsp;最佳的形式是在一开始就不引入错误。</p>
<ul>
<li>从数据来源讲：<ul>
<li>检查来源于外部的数据的值。</li>
<li>检查子程序的输入参数的值。</li>
</ul>
</li>
</ul>
<p>&amp;emsp;&amp;emsp;应重点检查外部输入数据（网络通讯传入、上层或下层传入、硬件设备采集数据）外部传入的数据对本模块的程序员来说往往是模糊和不可操控的，内部数据也较多依赖于外部输入数据，因此重点检查外部数据。内部数据可以只检查较为复杂的算式或算法结果。</p>
<h2 id="5-怎么检测？-1"><a href="#5-怎么检测？-1" class="headerlink" title="5 怎么检测？"></a>5 怎么检测？</h2><p>&amp;emsp;&amp;emsp;对参数进行失效检验意味着需要存储有一些有关参数的信息，可以定义结构体化的参数。我们对参数进行分类如下：</p>
<h3 id="5-1-功能型参数-1"><a href="#5-1-功能型参数-1" class="headerlink" title="5.1 功能型参数"></a>5.1 功能型参数</h3><p>&amp;emsp;&amp;emsp;用于表示某项功能开关的参数，我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Type redefinition------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Function enum definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Switch</span> &#123;</span>DISABLE, ENABLE&#125; ESwitch; <span class="comment">//Switch variable</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Functional parameter structure-----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FunParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ESwitch eSwitch;               <span class="comment">//Value: ENABLE or DISABLE</span></span><br><span class="line">    ESwitch ePrevious;             <span class="comment">//Previous value</span></span><br><span class="line">    Word wCounter;                 <span class="comment">//Enable or Disable time</span></span><br><span class="line">&#125;TFunParameter, * pTFunParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//functional parameter initialization------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor head temperature</span></span><br><span class="line">TFunParameter tfHeadTemp = &#123;.eSwitch = ENABLE,</span><br><span class="line">                            .ePrevious = DISABLE,</span><br><span class="line">                            .wCounter = <span class="number">0</span></span><br><span class="line">                            &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测功能开关状态切换的跳变变化。功能有时需要记录开启或者关闭时间，因此直接将定时器封装进结构体使得参数关系紧密。</em></p>
<p>&amp;emsp;&amp;emsp;对功能型参数使用枚举类型因此不需要检测值越界失效和符号异常失效，重要的是检测关联数据异常失效。比如功能A和B为互斥关系，一次只能有一个功能打开或两个功能都关闭，再比如功能B开启前应该先打开功能A。功能开关较多，关联性强的情况下这样的检测变得重要。<br>&amp;emsp;&amp;emsp;对于功能型参数的关联性检测可以放到预处理时期由编译器检测，不用等到外出调试才发现错误。预处理指令不能检测变量，考虑到功能有效性一旦确当后不在修改，但又要满足调试时可能存在的对功能开关的修改，可以通过以下形式实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//General macro definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ENABLE                    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISABLE                   0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//The switch of Function-------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_HEAD_TEMP             ENABLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_OIL_PRESS             DISABLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_HEAD_TEMP_STOP        ENABLE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Functional correlation detection---------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span>((FUN_HEAD_TEMP == FUN_OIL_PRESS) &amp;&amp; (FUN_HEAD_TEMP == ENABLE))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">error</span> 油压与油温为互斥功能,不能同时开启。</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span>((FUN_HEAD_TEMP_STOP == ENABLE) &amp;&amp; (FUN_HEAD_TEMP == DISABLE))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">error</span> 开启油温停机功能必须同时开启油温采样功能。</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//functional parameter initialization--------------------------------------------------------</span></span><br><span class="line">TFunParameter tfHeadTemp = &#123;.eSwitch = FUN_HEAD_TEMP, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;              <span class="comment">//Motor head temperature</span></span><br><span class="line">TFunParameter tfOilPress = &#123;.eSwitch = FUN_OIL_PRESS, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;              <span class="comment">//Oile press Function</span></span><br><span class="line">TFunParameter tfHeadTempStop = &#123;.eSwitch = FUN_HEAD_TEMP_STOP, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;     <span class="comment">//Motor Closed Function</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-状态型参数-1"><a href="#5-2-状态型参数-1" class="headerlink" title="5.2 状态型参数"></a>5.2 状态型参数</h3><p>&amp;emsp;&amp;emsp;状态型参数用于表示当前运行下的某种状态，是实时的因此不像常量宏可以用预处理指令检验。比如电机的开关波状态，阀门的开关状态，气压状态等。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Status enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">MotorPwm</span>&#123;</span>PWM_CLOSE, PWM_OPEN&#125;EMotorPwm;                 <span class="comment">//Motor Pwm Status</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">AirPressure</span>&#123;</span>AP_LOW, AP_NORMAL, AP_HIGH&#125;EAirPressure;    <span class="comment">//Air Pressure Status</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Status parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">StatusParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Byte byStatus;                           <span class="comment">//Current Status</span></span><br><span class="line">    Byte byPrevious;                         <span class="comment">//Previous value</span></span><br><span class="line">    Byte byFrequency;                        <span class="comment">//Status frequency</span></span><br><span class="line">    Word wCounter;                           <span class="comment">//Status duration time</span></span><br><span class="line">&#125;TStatusParameter, * pTStatusParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Status parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor Pwm Status</span></span><br><span class="line">TStatusParameter tsMotorPwm = &#123;.byStatus = PWM_OPEN,</span><br><span class="line">                                .byPrevious = PWM_CLOSE,</span><br><span class="line">                                .byFrequency = <span class="number">0</span>,</span><br><span class="line">                                .wCounter = <span class="number">0</span>                        <span class="comment">//Unit: s</span></span><br><span class="line">                                &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Air Pressure Status</span></span><br><span class="line">TStatusParameter tsAirPressure = &#123;.byStatus = AP_NORMAL,</span><br><span class="line">                                    .byPrevious = AP_NORMAL,</span><br><span class="line">                                    .byFrequency = <span class="number">0</span>,</span><br><span class="line">                                    .wCounter = <span class="number">0</span>                    <span class="comment">//Unit: ms</span></span><br><span class="line">                                    &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测状态转换的跳变变化。状态常常需要记录持续的时间，因此加入一个计数器可用于计时。在一段时间内有时还需要记录状态发生的次数，因此需要一个变量记录状态发生频度。</em></p>
<p>&amp;emsp;&amp;emsp;一种运行状态可能存在两种以上的状态值，且不同的状态值有不同的含义，因此无法用统一的枚举类型。对于一组状态值可以单独使用一组枚举表示，枚举的参数封装性更好，宏定义参数较“散”但省空间，综合多种因素在状态繁多的情况下我选择用封装性更好的枚举。<br>&amp;emsp;&amp;emsp;对于状态的检测，由于状态是随着程序运行实时变化的且不固定，因此无法在编译阶段对状态值的有效性检测。这就需要我们根据实际逻辑需要增加相应的检测代码。由于状态值都通过枚举定义好，因此不需要做参数越界失效和符号异常失效判断，状态值都是预知且固定的所以不需要跳变失效判断，其他失效根据实际情况添加检验代码。</p>
<h3 id="5-3-故障型参数。-1"><a href="#5-3-故障型参数。-1" class="headerlink" title="5.3 故障型参数。"></a>5.3 故障型参数。</h3><p>&amp;emsp;&amp;emsp;故障型参数用于记录当前或历史的故障发生情况，并决定是否要发出报警信号或停机等操作。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Unusual enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">UnusualSymbol</span>&#123;</span>ABNORMAL, NORMAL&#125;EUnusualSymbol;        <span class="comment">//Unusual state</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Unusual parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">UnusualParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    EUnusualSymbol eUnusualSymbol;                <span class="comment">//Unusual symbol</span></span><br><span class="line">    EUnusualSymbol ePrevious;                     <span class="comment">//Previous value</span></span><br><span class="line">    EUnusualSymbol eWarningSymbol;                <span class="comment">//Unusual Warning symbol</span></span><br><span class="line">    Byte byFrequency;                             <span class="comment">//Unusual frequency</span></span><br><span class="line">    Word wCounter;                                <span class="comment">//Unusual duration time</span></span><br><span class="line">&#125;TUnusualParameter, * pTUnusualParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Unusual parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Head temperature over</span></span><br><span class="line">TUnusualParameter tuHeadTempOver = &#123;.eUnusualSymbol   = NORMAL,</span><br><span class="line">                                    .ePrevious        = NORMAL,</span><br><span class="line">                                    .eWarningSymbol   = NORMAL,</span><br><span class="line">                                    .byFrequency      = <span class="number">0</span>,</span><br><span class="line">                                    .wCounter         = <span class="number">0</span>         <span class="comment">//Unit: ms</span></span><br><span class="line">                                    &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测故障的发生和恢复变化。对于故障常常需要检测故障的持续时间和频度，因此定义相关成员变量。根据故障的持续时间和频度有时会引起其他动作，比如报警或停机，因此引入报警标志。</em></p>
<p>&amp;emsp;&amp;emsp;故障的状态只需要两种，即异常或正常，因此可以同意定义枚举类型。<br>&amp;emsp;&amp;emsp;对于故障的检测，由于故障是在程序运行中发生，因此对故障参数有效性的检测需要实时进行。由于故障参数有固定的枚举类型，因此不需要越界失效、符号异常、跳变失效判断，其他失效根据实际情况添加检验代码。</p>
<h3 id="5-4-普通值参数。-1"><a href="#5-4-普通值参数。-1" class="headerlink" title="5.4 普通值参数。"></a>5.4 普通值参数。</h3><p>&amp;emsp;&amp;emsp;普通值参数是较为庞大的一类参数，这类参数的值类型不一，值之间的关联性可以很复杂，每种值各有特点，参数的有效性检验很难做统一的处理。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Sign enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Sign</span>&#123;</span>SIGN_MINUS = <span class="number">-1</span>, SIGN_PLUS = <span class="number">1</span>&#125;ESign;          <span class="comment">//Unusual state</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Lock</span>&#123;</span>LOCK_UNLOCK = <span class="number">0</span>, LOCK_LOCK = <span class="number">1</span>&#125;ELock;          <span class="comment">//Resource lock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Value parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ValueParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ESign eSign;                                <span class="comment">//Value: SIGN_PLUS of SIGN_MINUS</span></span><br><span class="line">    Word wValue;                                <span class="comment">//Current value</span></span><br><span class="line">    Word wPrevious;                             <span class="comment">//Previous value</span></span><br><span class="line">    Word wDefault;                              <span class="comment">//Default value</span></span><br><span class="line">    Word wCounter;                              <span class="comment">//duration time</span></span><br><span class="line">    Word wUpperLimit;                           <span class="comment">//Upper limit</span></span><br><span class="line">    Word wLowerLimit;                           <span class="comment">//Lower limit</span></span><br><span class="line">    Word wJumpLimit;                            <span class="comment">//Jump limit</span></span><br><span class="line">    Word wOverdueLimit;                         <span class="comment">//Overdue limit</span></span><br><span class="line">    Byte wLock;                                 <span class="comment">//Resource lock</span></span><br><span class="line">&#125;TValueParameter, * pTValueParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Value parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor Rpm</span></span><br><span class="line">TValueParameter tvMotorActualRpm = &#123;.eSign         = SIGN_PLUS,</span><br><span class="line">                                    .wValue        = <span class="number">0</span>,                <span class="comment">//Unit: Rpm</span></span><br><span class="line">                                    .wPrevious     = <span class="number">0</span>,</span><br><span class="line">                                    .wDefault      = <span class="number">1000</span>,</span><br><span class="line">                                    .wCounter      = <span class="number">0</span>,                <span class="comment">//Unit: ms</span></span><br><span class="line">                                    .wUpperLimit   = <span class="number">2000</span>,</span><br><span class="line">                                    .wLowerLimit   = <span class="number">0</span>,</span><br><span class="line">                                    .wJumpLimit    = <span class="number">1000</span>,</span><br><span class="line">                                    .wOverdueLimit = <span class="number">0</span>,                <span class="comment">//Unit: s</span></span><br><span class="line">                                    .wLock           = LOCK_UNLOCK</span><br><span class="line">                                    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Speed</span></span><br><span class="line">TValueParameter tvSpeed = &#123;.eSign         = SIGN_PLUS,</span><br><span class="line">                            .wValue        = <span class="number">0</span>,                <span class="comment">//Unit: 0.1K/M</span></span><br><span class="line">                            .wPrevious     = <span class="number">0</span>,</span><br><span class="line">                            .wDefault      = <span class="number">400</span>,</span><br><span class="line">                            .wCounter      = <span class="number">0</span>,                <span class="comment">//Unit: ms</span></span><br><span class="line">                            .wUpperLimit   = <span class="number">200</span>,</span><br><span class="line">                            .wLowerLimit   = <span class="number">0</span>,</span><br><span class="line">                            .wJumpLimit    = <span class="number">1000</span>,</span><br><span class="line">                            .wOverdueLimit = <span class="number">0</span>,                <span class="comment">//Unit: s</span></span><br><span class="line">                            .wLock          = LOCK_UNLOCK</span><br><span class="line">                            &#125;;</span><br></pre></td></tr></table></figure>

<h2 id="6-怎么处理？-1"><a href="#6-怎么处理？-1" class="headerlink" title="6 怎么处理？"></a>6 怎么处理？</h2><h3 id="6-1-用断言检查永远不应该发生的错误-1"><a href="#6-1-用断言检查永远不应该发生的错误-1" class="headerlink" title="6.1 用断言检查永远不应该发生的错误"></a>6.1 用断言检查永远不应该发生的错误</h3><p>&amp;emsp;&amp;emsp;优点：错误定位，给代码调试带来极大的便利，创建更稳定、质量更好且不易于出错的代码。<br>&amp;emsp;&amp;emsp;缺点：频繁的调用会极大的影响程序的性能，增加额外的开销。<br>&amp;emsp;&amp;emsp;相比于函数，调用函数需要额外的队栈开销，宏函数节省开销但同一段代码存在多个副本。使用宏函数会引起很多副作用需要小心。<br>&amp;emsp;&amp;emsp;断言使用形式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#define NDEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _assert(bExpression)                                 \</span></span><br><span class="line"><span class="meta">do&#123;                                                          \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!(bExpression))                                  \</span></span><br><span class="line"><span class="meta">        &#123;                                                    \</span></span><br><span class="line"><span class="meta">            ErrorDeal();            <span class="comment">/*Error deal*/</span>           \</span></span><br><span class="line"><span class="meta">        &#125;                                                    \</span></span><br><span class="line"><span class="meta">&#125;while(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _assert(bExpression)        ((void)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    Byte byNumber1 = <span class="number">10</span>;</span><br><span class="line">    Byte byNumber2 = <span class="number">0</span>;</span><br><span class="line">    Byte byResult  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    _assert(<span class="number">0</span> != byNumber2);        <span class="comment">//Cannot be 0</span></span><br><span class="line"></span><br><span class="line">    byResult = byNumber1 / byNumber2;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, byNumber2);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:通过定义宏NDEBUG来控制断言的开启或关断。用于对较为严重的错误统一处理。另外，禁止把必须执行的代码放在断言中，断言关闭后功能将失效。</em><br>&amp;emsp;&amp;emsp;用断言的两种形式：</p>
<ul>
<li>断言一直开启。不论是调试版还是发行版都将断言函数开启。</li>
<li>可以在测试时启用断言，而在部署时禁用断言。同样，程序投入运行后，最终用户在遇到问题时可以重新起用断言。它可以快速发现并定位软件问题，同时对系统错误进行自动报警。断言可以对在系统中隐藏很深，用其它手段极难发现的问题可以用断言来进行定位，从而缩短软件问题定位时间，提高系统的可测性。实际应用时，可根据具体情况灵活地设计断言。</li>
</ul>
<blockquote>
<ul>
<li>前置条件断言：代码执行之前必须具备的特性。</li>
<li>后置条件断言：代码执行之后必须具备的特性。</li>
<li>前后不变断言：代码执行前后不能变化的特性。</li>
</ul>
</blockquote>
<h3 id="6-2-错误处理代码-1"><a href="#6-2-错误处理代码-1" class="headerlink" title="6.2 错误处理代码"></a>6.2 错误处理代码</h3><p>&amp;emsp;&amp;emsp;用错误处理代码来处理预期会发生的状况，用断言来处理绝不应该发生的状况。通常用错误处理来检查有害的输入数据。断言检查代码中的bug。<br>&amp;emsp;&amp;emsp;根据情形的不同，你可以返回中立值、换用下一个正确数据、返回与前次相同的值、换用最接近的有效值、在日志文件中记录警告信息、返回一个错误吗、调用错误处理子程序或对象、显示出错信息或者关闭程序——或把这些技术结合起来使用。</p>
<h4 id="6-2-1-返回中立值-1"><a href="#6-2-1-返回中立值-1" class="headerlink" title="6.2.1 返回中立值"></a>6.2.1 返回中立值</h4><p>&amp;emsp;&amp;emsp;对于一些“危害”并不严重的错误，最佳的做法就是继续执行操作并简单的返回一个没有危害的数值，比如数值0或空指针。</p>
<h4 id="6-2-2-给出一个修正的数据-1"><a href="#6-2-2-给出一个修正的数据-1" class="headerlink" title="6.2.2 给出一个修正的数据"></a>6.2.2 给出一个修正的数据</h4><p>&amp;emsp;&amp;emsp;对于can网络中不断更新但实时性要求并不高的数据，比如电机温度，短时间内数据丢失可是使用历史值。</p>
<h4 id="6-2-3-换用最接近的合法值-1"><a href="#6-2-3-换用最接近的合法值-1" class="headerlink" title="6.2.3 换用最接近的合法值"></a>6.2.3 换用最接近的合法值</h4><p>&amp;emsp;&amp;emsp;有些情况下可以换用最接近的合法值，当值大于上限或者小于下限值时，可以直接去上下限边界值。</p>
<h4 id="6-2-4-把警告信息记录到日志文件中-1"><a href="#6-2-4-把警告信息记录到日志文件中-1" class="headerlink" title="6.2.4 把警告信息记录到日志文件中"></a>6.2.4 把警告信息记录到日志文件中</h4><p>&amp;emsp;&amp;emsp;在检测到错误数据的时候，你可以选择在日志文件中记录一条警告信息，然后继续执行。这种方法可以同其他的错误处理技术结合使用。</p>
<h4 id="6-2-5-返回一个错误码-1"><a href="#6-2-5-返回一个错误码-1" class="headerlink" title="6.2.5 返回一个错误码"></a>6.2.5 返回一个错误码</h4><p>&amp;emsp;&amp;emsp;你可以决定只让系统的某些部分处理错误。其他部分则不在本地（局部）处理错误，而只是简单地报告有错误发生和发生的是何种错误，并信任调用链上游的某个子程序会处理该错误。通知系统其余部分已经发生错误可以采用下列方法：</p>
<blockquote>
<ul>
<li>设置一个状态变量的值。</li>
<li>用状态值作为函数的返回值。</li>
<li>用语言内建的异常机制抛出一个异常。</li>
</ul>
</blockquote>
<p>&amp;emsp;&amp;emsp;需要决定系统里哪部分应该直接处理错误，哪部分只是报告所发生的错误。对于安全性很重要的部分请确认调用的子程序总会检查返回的错误码。</p>
<h4 id="6-2-6-调用错误处理子程序或对象-1"><a href="#6-2-6-调用错误处理子程序或对象-1" class="headerlink" title="6.2.6 调用错误处理子程序或对象"></a>6.2.6 调用错误处理子程序或对象</h4><p>&amp;emsp;&amp;emsp;这种方法需要把错误处理都集中在一个全局的错误处理子程序或对象中，使得调试工作更为简单。而代价是整个程序都要知道这个集中点并与之紧密耦合。如果你想在其他系统中重用其中的某些代码，那就得把错误处理代码一并带过去。</p>
<h4 id="6-2-7-错误发生时发出错误信息-1"><a href="#6-2-7-错误发生时发出错误信息-1" class="headerlink" title="6.2.7 错误发生时发出错误信息"></a>6.2.7 错误发生时发出错误信息</h4><p>&amp;emsp;&amp;emsp;在调试模式下，当错误发生时为了帮助调试者尽快定位问题所在位置，可以通过打印显示或者报文将错误信息较为详细的发出。</p>
<h4 id="6-2-8-在局部处理错误-1"><a href="#6-2-8-在局部处理错误-1" class="headerlink" title="6.2.8 在局部处理错误"></a>6.2.8 在局部处理错误</h4><p>&amp;emsp;&amp;emsp;针对一些设计方案可能更适合在局部立即解决所有遇到的问题，具体的错误处理方法需要由该模块的设计者根据问题特点自行决定。这种方法给力模块程序员很大的灵活度，但这样做会导致错误记录和发出错误信息等代码散布到整个系统中，从而使得设计者还得考虑错误记录和错误发送相关的故障问题。能在局部立即解决的问题最好在内部立即解决。</p>
<h4 id="6-2-9-关闭或复位程序-1"><a href="#6-2-9-关闭或复位程序-1" class="headerlink" title="6.2.9 关闭或复位程序"></a>6.2.9 关闭或复位程序</h4><p>&amp;emsp;&amp;emsp;程序发生较为严重的错误时，比如堆栈溢出导致运行环境被破坏，所依附的操作系统严重故障，甚至收到恶意攻击时可能需要关闭和复位程序。<br>&amp;emsp;&amp;emsp;确定一种通用的处理错误参数的方法，是架构层次（或称高层次）的设计决策。如果在高层次处理错误，低层次只是汇报错误，那么就要确保高层次真的处理有错误！千万不要忽略错误信息，在函数的返回值返回故障信息，记得检查函数的返回值，即使你对某个函数有足够的自信。当有错误产生时，请记录并反馈对应的故障码和它描述的信息。</p>
<h3 id="6-3-异常-1"><a href="#6-3-异常-1" class="headerlink" title="6.3 异常"></a>6.3 异常</h3><p>&amp;emsp;&amp;emsp;如果一个子程序在运行过程中遇到了预料之外的情况，但这个情况又必须处理否则会影响功能的使用或程序的运行，这个时候需要子程序将异常抛出，把“问题”交给能解释并处理好它的代码。这属于一种错误处理机制。<br>&amp;emsp;&amp;emsp;能在局部处理的错误优选在局部处理，不能立即处理或局部无法处理的问题可抛出异常。不能用异常来推卸责任。异常处理函数需要了解大量子程序可能抛出何种错误并给出处理办法，弱化了程序的封装性，增加了程序的复杂程度。<br>&amp;emsp;&amp;emsp;每种异常都对应一种特殊情况，因此要确保异常信息中含有为理解异常抛出原因所需的充分信息，这对于读取异常信息的人来说是很有价值的。比如当发生数据越界时，除了抛出对应的故障码标识数据越界外，还应该给出上下界和非法的数据值。<br>&amp;emsp;&amp;emsp;总结：断言、错误处理代码、异常都需要有完备的故障捕获处理，以及故障信息的记录反馈。因此有必要考虑一种方法以确保异常处理的一致性，即创建一个集中的异常报告机制。这个机制需要能对异常信息进行一个集中的格式化和存储。c语言不像c++和java自带异常机制，但c语言可以借助setjmp和longjmp实现异常处理机制。实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> String        char *              <span class="comment">//Don&#x27;t use typedef</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception information structure-----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Exception</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> * description;</span><br><span class="line">&#125;TException, * pTException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception stack structure------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ExceptionFrame</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ExceptionFrame</span> * <span class="title">prev</span>;</span></span><br><span class="line">    jmp_buf env;                          <span class="comment">//Use in setjmp()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Exception information</span></span><br><span class="line">    <span class="type">const</span> TException * ptException;       <span class="comment">//About Exception</span></span><br><span class="line">    <span class="type">const</span> String strFileName;             <span class="comment">//File name</span></span><br><span class="line">    <span class="type">const</span> String strFunctionName;         <span class="comment">//Function name</span></span><br><span class="line">    Word wLineNumber;                     <span class="comment">//Line number</span></span><br><span class="line">&#125;TExceptionFrame, * pTExceptionFrame;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception status----------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">ExceptionStatus</span>&#123;</span></span><br><span class="line">    EXCEPT_ENTERED = <span class="number">0</span>,</span><br><span class="line">    EXCEPT_RAISED,</span><br><span class="line">    EXCEPT_HANDLED,</span><br><span class="line">    EXCEPT_FINALIZED</span><br><span class="line">&#125;EExceptionStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">*                try-catch-finally definition                *</span></span><br><span class="line"><span class="comment">*************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//try deal--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _try                                                                     \</span></span><br><span class="line"><span class="meta">&#123;                                                                                \</span></span><br><span class="line"><span class="meta">    Byte byExceptFlg;                                    <span class="comment">/*Return by setjmp()*/</span>  \</span></span><br><span class="line"><span class="meta">    TExceptionFrame tExceptionNode;                                              \</span></span><br><span class="line"><span class="meta">                                                                                 \</span></span><br><span class="line"><span class="meta">    <span class="comment">/*Push stack*/</span>                                                               \</span></span><br><span class="line"><span class="meta">    tExceptionNode.prev = ptExceptionStackTop;                                   \</span></span><br><span class="line"><span class="meta">    ptExceptionStackTop = &amp;tExceptionNode;                                       \</span></span><br><span class="line"><span class="meta">                                                                                 \</span></span><br><span class="line"><span class="meta">    byExceptFlg = setjmp(tExceptionNode.env);            <span class="comment">/*Set jump point*/</span>      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                                            \</span></span><br><span class="line"><span class="meta">    &#123;</span></span><br><span class="line">        <span class="comment">/*Here check and throw your exception*/</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//catch deal-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _catch(tException)                                                       \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>        \</span></span><br><span class="line"><span class="meta">        &#123;                                                                        \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span>  \</span></span><br><span class="line"><span class="meta">        &#125;                                                                        \</span></span><br><span class="line"><span class="meta">    &#125;                                                                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> <span class="keyword">if</span>(&amp;(tException) == tExceptionNode.ptException)                         \</span></span><br><span class="line"><span class="meta">    &#123;                                                                            \</span></span><br><span class="line"><span class="meta">        byExceptFlg = EXCEPT_HANDLED;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*Here deal your exception*/</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//finally deal------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _finally                                                                \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span> \</span></span><br><span class="line"><span class="meta">        &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">    &#123;                                                                           \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                                       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            byExceptFlg = EXCEPT_FINALIZED;                                     \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*Here must deal*/</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//end try deal-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _end_try                                                                \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span> \</span></span><br><span class="line"><span class="meta">        &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(EXCEPT_RAISED == byExceptFlg)                                            \</span></span><br><span class="line"><span class="meta">    &#123;                                                                           \</span></span><br><span class="line"><span class="meta">                                                                                \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">&#125;while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//_throw() deal------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _throw(tException) ExceptRaise(&amp;(tException), __FILE__, __FUNCTION__, __LINE__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">*                Exception deal function                     *</span></span><br><span class="line"><span class="comment">*************************************************************/</span></span><br><span class="line">pTExceptionFrame ptExceptionStackTop = <span class="literal">NULL</span>;            <span class="comment">//Stack top</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ExceptRaise</span><span class="params">(<span class="type">const</span> TException * <span class="type">const</span> ptException,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> String <span class="type">const</span> strFileName,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> String <span class="type">const</span> strFunctionN  ame,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> wLineNumber)</span></span><br><span class="line">&#123;</span><br><span class="line">    pTExceptionFrame pStackTop = ptExceptionStackTop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == ptException)                             <span class="comment">//Check NULL exception</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Do Something</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">NULL</span> == pStackTop)                           <span class="comment">//Check stack empty</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Do Something</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Record some information</span></span><br><span class="line">            pStackTop -&gt; ptException = ptException;</span><br><span class="line">            pStackTop -&gt; strFileName = strFileName;</span><br><span class="line">            pStackTop -&gt; strFunctionName = strFunctionName;</span><br><span class="line">            pStackTop -&gt; wLineNumber = wLineNumber;</span><br><span class="line"></span><br><span class="line">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;      <span class="comment">//Pop stack</span></span><br><span class="line"></span><br><span class="line">            longjmp(pStackTop -&gt; env, EXCEPT_RAISED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    TException A = &#123;<span class="string">&quot;A exception&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    _try</span><br><span class="line">    &#123;</span><br><span class="line">        _throw(A);</span><br><span class="line">    &#125;</span><br><span class="line">    _catch(A)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A exception\n&quot;</span>);</span><br><span class="line">    &#125;_end_try;</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&amp;emsp;&amp;emsp;预料之外的错误处理。<br>&amp;emsp;&amp;emsp;异常中没有捕获到的异常情况，我们认为是意外异常，发生意外异常时的一种常见做法是终止程序运行。</p>
<h3 id="6-4-隔栏-1"><a href="#6-4-隔栏-1" class="headerlink" title="6.4 隔栏"></a>6.4 隔栏</h3><p>&amp;emsp;&amp;emsp;数据源有两类，一类是外部传入一类是内部运算产生。由于外部数据的处理过程和存储环境对本模块设计者来说是模糊或不可见的，而内部数据处理直接或间接依赖于外部数据。因此我们假定外部数据是肮脏且不可信的，内部数据假定为干净（仅对少量安全性高数据检测）。不可信的外部数据传入内部需要一个统一数据清理的环节，这就是隔栏的作用。<br>&amp;emsp;&amp;emsp;隔栏与断言的关系：<br>&amp;emsp;&amp;emsp;隔栏的使用使断言和错误处理有了清晰的区分。隔栏外部的数据应该使用错误处理技术，在那里对数据做到任何假定都是不安全的。而隔栏内部的程序里就应该使用断言技术，因为传进来的数据都已在通过隔栏时被清理过了。如果隔栏内部的某个子程序检测到了错误的数据，那么应该是程序李的错误而不是数据里的错误。</p>
<p align="right">——《代码大全2》</p>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/grille.jpg" alt="grille.png" title="grille"></p>
<h3 id="6-5-错误日志处理。"><a href="#6-5-错误日志处理。" class="headerlink" title="6.5 错误日志处理。"></a>6.5 错误日志处理。</h3><p>&amp;emsp;&amp;emsp;随着项目规模的不断扩大，日志的应用对于维护程序的正常运行具有重要的意义。当一个程序崩溃时如果没有抛出异常信息，对于维护人员来说无法快速定位问题，更别谈去解决问题了。<br>日志时程序员解决问题的第一手资料。异常发生时，从别人口述的情况往往存在不准确或模糊，为了更好的解决问题我们需要当时发生了什么，用户当时做了什么操作，运行环境有无异常，数据有哪些变化，异常时否反复发生，是偶发还是有必然起因。若日志做了详细记录对于问题的定位和解决起到举足轻重的作用。</p>
<h4 id="6-5-1-日志的作用"><a href="#6-5-1-日志的作用" class="headerlink" title="6.5.1 日志的作用"></a>6.5.1 日志的作用</h4><ol>
<li>记录用户操作的审计日志，甚至就是监管部门的要求。</li>
<li>记录程序运行的流程。</li>
<li>记录数据的变化。</li>
<li>记录异常信息，快速定位问题根源。</li>
<li>数据统计和性能分析（程序性能或设备性能）。</li>
</ol>
<h4 id="6-5-2-如何做好程序日志"><a href="#6-5-2-如何做好程序日志" class="headerlink" title="6.5.2 如何做好程序日志"></a>6.5.2 如何做好程序日志</h4><ol>
<li><p>日志的可读性<br> &amp;emsp;&amp;emsp;看日志的是程序员，但并不一定是接触过相关模块或看过这部分源码的程序员。日志应该一路了然，信息详细但又不重复冗余。日志信息应该准确可靠，避免含糊不清的日志。</p>
</li>
<li><p>日志的资源消耗<br> &amp;emsp;&amp;emsp;日志的记录毫无疑问需要消耗资源，占用程序运行的时间资源、占用io口写入文件或数据库，占用磁盘或EE存储。日志信息应该简明扼要，避免打印无意义的日志，减少重复日志。日志应该做成滚动式，记录一段时间内的日志和错误等级高的日志，防止日志文件写满存储空间。</p>
</li>
<li><p>日志应该分等级<br> &amp;emsp;&amp;emsp;日志的等级可以分为FATAL、ERROR、INFO、DEBUG、TRACE。</p>
<ol>
<li><p>FATAL（致命）<br> FATAL是错误等级最高的重大错误，它的出现程序无法自我恢复，必须通过复位程序才能运行。该类错误应该记录错误码。</p>
</li>
<li><p>ERROR（错误）<br> 这类错误虽然发生，但可以通过程序来弥补或忽略来保证程序正常运行。该类错误需要记录错误码。</p>
</li>
<li><p>WARN（警告）<br> 表示会出现潜在错误的情形，比如参数未传入，使用默认了参数，参数持续时长一直未变化，这类错误虽异常但在程序员预期之内，并且程序做了充分的弥补措施。也建议记录错误码。</p>
</li>
<li><p>INFO（信息）<br> 用于记录程序的运行过程，打印一些程序运行中的重要信息，但要避免滥用。</p>
</li>
<li><p>DEBUG（调试）<br> 用于开发调试过程中，由程序员自由控制，具有较高灵活度。</p>
</li>
<li><p>TRACE（跟踪）<br> 一般不使用。用于跟踪函数的调用，不含变量只反应函数调用关系。</p>
</li>
</ol>
</li>
</ol>
<p>&amp;emsp;&amp;emsp;代码示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Log Level definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">LogLevel</span> &#123;</span>LOG_LEVEL_TRACE, LOG_LEVEL_DEBUG, LOG_LEVEL_INFO, LOG_LEVEL_WARN, LOG_LEVEL_ERROR, LOG_LEVEL_FATAL&#125; ELogLevel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义FATAL级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_FATAL(wFaultCode, strFormat, ...)         LogPrint(LOG_LEVEL_FATAL, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义ERROR级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_ERROR(wFaultCode, strFormat, ...)         LogPrint(LOG_LEVEL_ERROR, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义WARN级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_WARN(wFaultCode, strFormat, ...)          LogPrint(LOG_LEVEL_WARN, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义INFO级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_INFO(strFormat, ...)          LogPrint(LOG_LEVEL_INFO, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义DEBUG级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_DEBUG(strFormat, ...)         LogPrint(LOG_LEVEL_DEBUG, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义TRACE级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TRACE(strFormat, ...)         LogPrint(LOG_LEVEL_TRACE, <span class="string">&quot;[%s &lt;%d&gt;)](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure>
<p>&amp;emsp;&amp;emsp;输出结果展示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/Demo%20log.png" alt="Demo log.png" title="Demo log"></p>
<h3 id="6-6-错误码"><a href="#6-6-错误码" class="headerlink" title="6.6 错误码"></a>6.6 错误码</h3><p>&amp;emsp;&amp;emsp;软件运行中由于错误类型众多，为了对错误进行区分，系统设定了错误码（error code），软件通过内部的自检机制超出错误并抛出给开发人员，开发人员通过错误码快速分析错误原因。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Error description----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Belongs to</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AIR_COMPRESSOR                          (0X01 &lt;&lt; 24)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STEERING_MOTOR                          (0X02 &lt;&lt; 24)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Error level</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_1                           (0X01 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_2                           (0X02 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_3                           (0X03 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_4                           (0X04 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_5                           (0X05 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_6                           (0X06 &lt;&lt; 16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Error categories</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CATEGORIES_FUNCTION                     (0X01 &lt;&lt; 8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CATEGORIES_VALUE                        (0X02 &lt;&lt; 8)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//About function</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DOMAIN_ERROR                            (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X01)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RANGE_ERROR                             (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X02)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INVALID_ARGUMENT                        (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X03)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//About value</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OVERFLOW_ERROR                          (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X01)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERFLOW_ERROR                         (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X02)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OUT_OF_BOUNDS                           (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X03)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LENGTH_ERROR                            (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X04)</span></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<h3 id="6-7-调试log"><a href="#6-7-调试log" class="headerlink" title="6.7 调试log"></a>6.7 调试log</h3><p>&amp;emsp;&amp;emsp;跟踪代码运行轨迹，担当开发环境中的调试利器，提高开发效率，增强查错能力。<br>&amp;emsp;&amp;emsp;区别出产品代码与开发代码。产品级软件要求运行快速、节约资源、较高安全性，而开发中的软件可以运行缓慢、资源利用奢侈、提供一些额外的辅助调试的不安全操作。开发期间牺牲一些速度和资源换取使开发顺畅的内置工具，比如调试log，用于监视程序运行流程和数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> Uint16;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Function enum definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Switch</span> &#123;</span>DISABLE, ENABLE&#125; ESwitch; <span class="comment">//Switch variable</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG_LOG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG_LOG</span></span><br><span class="line">    <span class="comment">//Global variable-----------------------------------------------------------------</span></span><br><span class="line">    ESwitch bDebugSwtich = DISABLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Switch function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_SWITCH(bSwitch)        bDebugSwtich = (bSwitch)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Basic function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_ENTER_FUN()            (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. &lt;-----Enter function - %s -----&gt;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_EXIT_FUN()             (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. &lt;-----Exit function - %s -----&gt;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_PRINT(strFormat, ...)  (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ---&gt;&gt; &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_RETURN(Ret)            (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ===&gt;&gt; Ret: %#08X\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, Ret);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Extension function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_NUMBER(Number)         (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ---&gt;&gt; &quot;</span> #Number <span class="string">&quot; = %d\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, Number)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">//Switch function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_SWITCH(bSwitch)        ((void)0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Basic function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_ENTER_FUN()            ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_EXIT_FUN()             ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_PRINT(strFormat, ...)  ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_RETURN(Ret)            ((void)0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Extension function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_NUMBER(Number)         ((void)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> b = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> Return = <span class="number">0x00000001</span>;</span><br><span class="line"></span><br><span class="line">    DEBUG_SWITCH(ENABLE);</span><br><span class="line">    DEBUG_ENTER_FUN();</span><br><span class="line"></span><br><span class="line">    a = <span class="number">10</span>;</span><br><span class="line">    DEBUG_NUMBER(a);</span><br><span class="line">    b = <span class="number">2</span>;</span><br><span class="line">    DEBUG_NUMBER(b);</span><br><span class="line">    sum = a + b;</span><br><span class="line">    DEBUG_PRINT(<span class="string">&quot;%d  = %d + %d&quot;</span>, sum, a, b);</span><br><span class="line"></span><br><span class="line">    DEBUG_RETURN(Return);</span><br><span class="line">    DEBUG_EXIT_FUN();</span><br><span class="line">    DEBUG_SWITCH(DISABLE);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&amp;emsp;&amp;emsp;输出结果展示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/Debug%20log.png" alt="Debug log" title="Debug log"></p>
<h3 id="6-8-正确性与健壮性抉择。"><a href="#6-8-正确性与健壮性抉择。" class="headerlink" title="6.8 正确性与健壮性抉择。"></a>6.8 正确性与健壮性抉择。</h3><p>&amp;emsp;&amp;emsp;正确性意味着结果永远是正确的，如果出错，宁愿不给出结果也不要给定一个不准确的值。<br>&amp;emsp;&amp;emsp;健壮性意味着通过一些措施，保证软件能正常运行下去，即使有时候会有一些不准确的值出现。<br></br></p>
<h3 id="6-9-进攻式编程。"><a href="#6-9-进攻式编程。" class="headerlink" title="6.9 进攻式编程。"></a>6.9 进攻式编程。</h3><p>&amp;emsp;&amp;emsp;它的思想主要是提倡在开发阶段让问题尽可能显现出来，并且将问题扩大使得问题难以被忽视，这样才有助于问题不被忽视得到解决。而在产品运行时解决问题或让它能够自我纠正恢复。</p>
<h3 id="6-5-错误日志处理。-1"><a href="#6-5-错误日志处理。-1" class="headerlink" title="6.5 错误日志处理。"></a>6.5 错误日志处理。</h3><p>&amp;emsp;&amp;emsp;随着项目规模的不断扩大，日志的应用对于维护程序的正常运行具有重要的意义。当一个程序崩溃时如果没有抛出异常信息，对于维护人员来说无法快速定位问题，更别谈去解决问题了。<br>日志时程序员解决问题的第一手资料。异常发生时，从别人口述的情况往往存在不准确或模糊，为了更好的解决问题我们需要当时发生了什么，用户当时做了什么操作，运行环境有无异常，数据有哪些变化，异常时否反复发生，是偶发还是有必然起因。若日志做了详细记录对于问题的定位和解决起到举足轻重的作用。</p>
<h4 id="6-5-1-日志的作用-1"><a href="#6-5-1-日志的作用-1" class="headerlink" title="6.5.1 日志的作用"></a>6.5.1 日志的作用</h4><ol>
<li>记录用户操作的审计日志，甚至就是监管部门的要求。</li>
<li>记录程序运行的流程。</li>
<li>记录数据的变化。</li>
<li>记录异常信息，快速定位问题根源。</li>
<li>数据统计和性能分析（程序性能或设备性能）。</li>
</ol>
<h4 id="6-5-2-如何做好程序日志-1"><a href="#6-5-2-如何做好程序日志-1" class="headerlink" title="6.5.2 如何做好程序日志"></a>6.5.2 如何做好程序日志</h4><ol>
<li><p>日志的可读性<br> &amp;emsp;&amp;emsp;看日志的是程序员，但并不一定是接触过相关模块或看过这部分源码的程序员。日志应该一路了然，信息详细但又不重复冗余。日志信息应该准确可靠，避免含糊不清的日志。</p>
</li>
<li><p>日志的资源消耗<br> &amp;emsp;&amp;emsp;日志的记录毫无疑问需要消耗资源，占用程序运行的时间资源、占用io口写入文件或数据库，占用磁盘或EE存储。日志信息应该简明扼要，避免打印无意义的日志，减少重复日志。日志应该做成滚动式，记录一段时间内的日志和错误等级高的日志，防止日志文件写满存储空间。</p>
</li>
<li><p>日志应该分等级<br> &amp;emsp;&amp;emsp;日志的等级可以分为FATAL、ERROR、INFO、DEBUG、TRACE。</p>
<ol>
<li><p>FATAL（致命）<br> FATAL是错误等级最高的重大错误，它的出现程序无法自我恢复，必须通过复位程序才能运行。该类错误应该记录错误码。</p>
</li>
<li><p>ERROR（错误）<br> 这类错误虽然发生，但可以通过程序来弥补或忽略来保证程序正常运行。该类错误需要记录错误码。</p>
</li>
<li><p>WARN（警告）<br> 表示会出现潜在错误的情形，比如参数未传入，使用默认了参数，参数持续时长一直未变化，这类错误虽异常但在程序员预期之内，并且程序做了充分的弥补措施。也建议记录错误码。</p>
</li>
<li><p>INFO（信息）<br> 用于记录程序的运行过程，打印一些程序运行中的重要信息，但要避免滥用。</p>
</li>
<li><p>DEBUG（调试）<br> 用于开发调试过程中，由程序员自由控制，具有较高灵活度。</p>
</li>
<li><p>TRACE（跟踪）<br> 一般不使用。用于跟踪函数的调用，不含变量只反应函数调用关系。</p>
</li>
</ol>
</li>
</ol>
<p>&amp;emsp;&amp;emsp;代码示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Log Level definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">LogLevel</span> &#123;</span>LOG_LEVEL_TRACE, LOG_LEVEL_DEBUG, LOG_LEVEL_INFO, LOG_LEVEL_WARN, LOG_LEVEL_ERROR, LOG_LEVEL_FATAL&#125; ELogLevel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义FATAL级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_FATAL(wFaultCode, strFormat, ...)         LogPrint(LOG_LEVEL_FATAL, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义ERROR级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_ERROR(wFaultCode, strFormat, ...)         LogPrint(LOG_LEVEL_ERROR, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义WARN级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_WARN(wFaultCode, strFormat, ...)          LogPrint(LOG_LEVEL_WARN, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义INFO级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_INFO(strFormat, ...)          LogPrint(LOG_LEVEL_INFO, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义DEBUG级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_DEBUG(strFormat, ...)         LogPrint(LOG_LEVEL_DEBUG, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义TRACE级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TRACE(strFormat, ...)         LogPrint(LOG_LEVEL_TRACE, <span class="string">&quot;[%s &lt;%d&gt;)](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure>
<p>&amp;emsp;&amp;emsp;输出结果展示：</p>
<h1 id="参数有效性检验-2"><a href="#参数有效性检验-2" class="headerlink" title="参数有效性检验"></a><center>参数有效性检验</center></h1><p><em>前言：</em><br>&amp;emsp;&amp;emsp;<em>2018-11-26天气凉，耗时三个周末完成这篇原创文章，记录下自己关于程序安全性方面的一些微薄见解。愿自己程序员之路越走越顺利，保持激情初心，不忘理想前行。</em></p>
<h2 id="1-问题：-2"><a href="#1-问题：-2" class="headerlink" title="1 问题："></a>1 问题：</h2><ul>
<li>为什么要检验？</li>
<li>哪些情况判为参数失效？</li>
<li>有哪些参数需要检验？</li>
<li>怎么检测？</li>
<li>在哪里检验？</li>
<li>怎么处理？</li>
</ul>
<h2 id="2-为什么要检验？-2"><a href="#2-为什么要检验？-2" class="headerlink" title="2 为什么要检验？"></a>2 为什么要检验？</h2><p>&amp;emsp;&amp;emsp;保护程序免糟非法输入数据的破坏，尽可能将异常数据对程序造成的影响控制在有限的范围内。<br>&amp;emsp;&amp;emsp;防御式编程主要思想：子程序应该不因传入错误数据而被破坏，哪怕是由其他子程序产生的错误数据。更一般地说，其核心思想是承认程序都会有问题，都需要被修改，聪明的程序员应该根据这一点来编程。<br>&amp;emsp;&amp;emsp;不管进来什么，好的程序都不会生成垃圾，而是做到“垃圾进，什么都不出”、“进来垃圾，出去是错误提示”或“不许垃圾进来”。</p>
<p align="right">——《代码大全2》第8章 防御式编程</p>

<h2 id="3-哪些情况判为参数失效？-2"><a href="#3-哪些情况判为参数失效？-2" class="headerlink" title="3 哪些情况判为参数失效？"></a>3 哪些情况判为参数失效？</h2><ul>
<li>参数越界失效：参数值不在预期范围内。比如参数值超过上下限，数组下标越界。</li>
<li>符号异常失效：指正负号异常，应该尽可能使用无符号类型。</li>
<li>空指针失效：传递空指针。</li>
<li>数据过期失效：原本实时更新的数据长期未变化。</li>
<li>跳变失效：数据波动异常的大或小。</li>
<li>关联数据异常失效：指两个以上的数据值之间有依赖和关联，当值不符合依赖关联性时认为失效。</li>
</ul>
<h2 id="4-有哪些参数需要检验？-2"><a href="#4-有哪些参数需要检验？-2" class="headerlink" title="4 有哪些参数需要检验？"></a>4 有哪些参数需要检验？</h2><p>&amp;emsp;&amp;emsp;最佳的形式是在一开始就不引入错误。</p>
<ul>
<li>从数据来源讲：<ul>
<li>检查来源于外部的数据的值。</li>
<li>检查子程序的输入参数的值。</li>
</ul>
</li>
</ul>
<p>&amp;emsp;&amp;emsp;应重点检查外部输入数据（网络通讯传入、上层或下层传入、硬件设备采集数据）外部传入的数据对本模块的程序员来说往往是模糊和不可操控的，内部数据也较多依赖于外部输入数据，因此重点检查外部数据。内部数据可以只检查较为复杂的算式或算法结果。</p>
<h2 id="5-怎么检测？-2"><a href="#5-怎么检测？-2" class="headerlink" title="5 怎么检测？"></a>5 怎么检测？</h2><p>&amp;emsp;&amp;emsp;对参数进行失效检验意味着需要存储有一些有关参数的信息，可以定义结构体化的参数。我们对参数进行分类如下：</p>
<h3 id="5-1-功能型参数-2"><a href="#5-1-功能型参数-2" class="headerlink" title="5.1 功能型参数"></a>5.1 功能型参数</h3><p>&amp;emsp;&amp;emsp;用于表示某项功能开关的参数，我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Type redefinition------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Function enum definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Switch</span> &#123;</span>DISABLE, ENABLE&#125; ESwitch; <span class="comment">//Switch variable</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Functional parameter structure-----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FunParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ESwitch eSwitch;               <span class="comment">//Value: ENABLE or DISABLE</span></span><br><span class="line">    ESwitch ePrevious;             <span class="comment">//Previous value</span></span><br><span class="line">    Word wCounter;                 <span class="comment">//Enable or Disable time</span></span><br><span class="line">&#125;TFunParameter, * pTFunParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//functional parameter initialization------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor head temperature</span></span><br><span class="line">TFunParameter tfHeadTemp = &#123;.eSwitch = ENABLE,</span><br><span class="line">                            .ePrevious = DISABLE,</span><br><span class="line">                            .wCounter = <span class="number">0</span></span><br><span class="line">                            &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测功能开关状态切换的跳变变化。功能有时需要记录开启或者关闭时间，因此直接将定时器封装进结构体使得参数关系紧密。</em></p>
<p>&amp;emsp;&amp;emsp;对功能型参数使用枚举类型因此不需要检测值越界失效和符号异常失效，重要的是检测关联数据异常失效。比如功能A和B为互斥关系，一次只能有一个功能打开或两个功能都关闭，再比如功能B开启前应该先打开功能A。功能开关较多，关联性强的情况下这样的检测变得重要。<br>&amp;emsp;&amp;emsp;对于功能型参数的关联性检测可以放到预处理时期由编译器检测，不用等到外出调试才发现错误。预处理指令不能检测变量，考虑到功能有效性一旦确当后不在修改，但又要满足调试时可能存在的对功能开关的修改，可以通过以下形式实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//General macro definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ENABLE                    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISABLE                   0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//The switch of Function-------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_HEAD_TEMP             ENABLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_OIL_PRESS             DISABLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_HEAD_TEMP_STOP        ENABLE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Functional correlation detection---------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span>((FUN_HEAD_TEMP == FUN_OIL_PRESS) &amp;&amp; (FUN_HEAD_TEMP == ENABLE))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">error</span> 油压与油温为互斥功能,不能同时开启。</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span>((FUN_HEAD_TEMP_STOP == ENABLE) &amp;&amp; (FUN_HEAD_TEMP == DISABLE))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">error</span> 开启油温停机功能必须同时开启油温采样功能。</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//functional parameter initialization--------------------------------------------------------</span></span><br><span class="line">TFunParameter tfHeadTemp = &#123;.eSwitch = FUN_HEAD_TEMP, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;              <span class="comment">//Motor head temperature</span></span><br><span class="line">TFunParameter tfOilPress = &#123;.eSwitch = FUN_OIL_PRESS, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;              <span class="comment">//Oile press Function</span></span><br><span class="line">TFunParameter tfHeadTempStop = &#123;.eSwitch = FUN_HEAD_TEMP_STOP, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;     <span class="comment">//Motor Closed Function</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-状态型参数-2"><a href="#5-2-状态型参数-2" class="headerlink" title="5.2 状态型参数"></a>5.2 状态型参数</h3><p>&amp;emsp;&amp;emsp;状态型参数用于表示当前运行下的某种状态，是实时的因此不像常量宏可以用预处理指令检验。比如电机的开关波状态，阀门的开关状态，气压状态等。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Status enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">MotorPwm</span>&#123;</span>PWM_CLOSE, PWM_OPEN&#125;EMotorPwm;                 <span class="comment">//Motor Pwm Status</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">AirPressure</span>&#123;</span>AP_LOW, AP_NORMAL, AP_HIGH&#125;EAirPressure;    <span class="comment">//Air Pressure Status</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Status parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">StatusParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Byte byStatus;                           <span class="comment">//Current Status</span></span><br><span class="line">    Byte byPrevious;                         <span class="comment">//Previous value</span></span><br><span class="line">    Byte byFrequency;                        <span class="comment">//Status frequency</span></span><br><span class="line">    Word wCounter;                           <span class="comment">//Status duration time</span></span><br><span class="line">&#125;TStatusParameter, * pTStatusParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Status parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor Pwm Status</span></span><br><span class="line">TStatusParameter tsMotorPwm = &#123;.byStatus = PWM_OPEN,</span><br><span class="line">                                .byPrevious = PWM_CLOSE,</span><br><span class="line">                                .byFrequency = <span class="number">0</span>,</span><br><span class="line">                                .wCounter = <span class="number">0</span>                        <span class="comment">//Unit: s</span></span><br><span class="line">                                &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Air Pressure Status</span></span><br><span class="line">TStatusParameter tsAirPressure = &#123;.byStatus = AP_NORMAL,</span><br><span class="line">                                    .byPrevious = AP_NORMAL,</span><br><span class="line">                                    .byFrequency = <span class="number">0</span>,</span><br><span class="line">                                    .wCounter = <span class="number">0</span>                    <span class="comment">//Unit: ms</span></span><br><span class="line">                                    &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测状态转换的跳变变化。状态常常需要记录持续的时间，因此加入一个计数器可用于计时。在一段时间内有时还需要记录状态发生的次数，因此需要一个变量记录状态发生频度。</em></p>
<p>&amp;emsp;&amp;emsp;一种运行状态可能存在两种以上的状态值，且不同的状态值有不同的含义，因此无法用统一的枚举类型。对于一组状态值可以单独使用一组枚举表示，枚举的参数封装性更好，宏定义参数较“散”但省空间，综合多种因素在状态繁多的情况下我选择用封装性更好的枚举。<br>&amp;emsp;&amp;emsp;对于状态的检测，由于状态是随着程序运行实时变化的且不固定，因此无法在编译阶段对状态值的有效性检测。这就需要我们根据实际逻辑需要增加相应的检测代码。由于状态值都通过枚举定义好，因此不需要做参数越界失效和符号异常失效判断，状态值都是预知且固定的所以不需要跳变失效判断，其他失效根据实际情况添加检验代码。</p>
<h3 id="5-3-故障型参数。-2"><a href="#5-3-故障型参数。-2" class="headerlink" title="5.3 故障型参数。"></a>5.3 故障型参数。</h3><p>&amp;emsp;&amp;emsp;故障型参数用于记录当前或历史的故障发生情况，并决定是否要发出报警信号或停机等操作。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Unusual enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">UnusualSymbol</span>&#123;</span>ABNORMAL, NORMAL&#125;EUnusualSymbol;        <span class="comment">//Unusual state</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Unusual parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">UnusualParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    EUnusualSymbol eUnusualSymbol;                <span class="comment">//Unusual symbol</span></span><br><span class="line">    EUnusualSymbol ePrevious;                     <span class="comment">//Previous value</span></span><br><span class="line">    EUnusualSymbol eWarningSymbol;                <span class="comment">//Unusual Warning symbol</span></span><br><span class="line">    Byte byFrequency;                             <span class="comment">//Unusual frequency</span></span><br><span class="line">    Word wCounter;                                <span class="comment">//Unusual duration time</span></span><br><span class="line">&#125;TUnusualParameter, * pTUnusualParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Unusual parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Head temperature over</span></span><br><span class="line">TUnusualParameter tuHeadTempOver = &#123;.eUnusualSymbol   = NORMAL,</span><br><span class="line">                                    .ePrevious        = NORMAL,</span><br><span class="line">                                    .eWarningSymbol   = NORMAL,</span><br><span class="line">                                    .byFrequency      = <span class="number">0</span>,</span><br><span class="line">                                    .wCounter         = <span class="number">0</span>         <span class="comment">//Unit: ms</span></span><br><span class="line">                                    &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测故障的发生和恢复变化。对于故障常常需要检测故障的持续时间和频度，因此定义相关成员变量。根据故障的持续时间和频度有时会引起其他动作，比如报警或停机，因此引入报警标志。</em></p>
<p>&amp;emsp;&amp;emsp;故障的状态只需要两种，即异常或正常，因此可以同意定义枚举类型。<br>&amp;emsp;&amp;emsp;对于故障的检测，由于故障是在程序运行中发生，因此对故障参数有效性的检测需要实时进行。由于故障参数有固定的枚举类型，因此不需要越界失效、符号异常、跳变失效判断，其他失效根据实际情况添加检验代码。</p>
<h3 id="5-4-普通值参数。-2"><a href="#5-4-普通值参数。-2" class="headerlink" title="5.4 普通值参数。"></a>5.4 普通值参数。</h3><p>&amp;emsp;&amp;emsp;普通值参数是较为庞大的一类参数，这类参数的值类型不一，值之间的关联性可以很复杂，每种值各有特点，参数的有效性检验很难做统一的处理。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Sign enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Sign</span>&#123;</span>SIGN_MINUS = <span class="number">-1</span>, SIGN_PLUS = <span class="number">1</span>&#125;ESign;          <span class="comment">//Unusual state</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Lock</span>&#123;</span>LOCK_UNLOCK = <span class="number">0</span>, LOCK_LOCK = <span class="number">1</span>&#125;ELock;          <span class="comment">//Resource lock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Value parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ValueParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ESign eSign;                                <span class="comment">//Value: SIGN_PLUS of SIGN_MINUS</span></span><br><span class="line">    Word wValue;                                <span class="comment">//Current value</span></span><br><span class="line">    Word wPrevious;                             <span class="comment">//Previous value</span></span><br><span class="line">    Word wDefault;                              <span class="comment">//Default value</span></span><br><span class="line">    Word wCounter;                              <span class="comment">//duration time</span></span><br><span class="line">    Word wUpperLimit;                           <span class="comment">//Upper limit</span></span><br><span class="line">    Word wLowerLimit;                           <span class="comment">//Lower limit</span></span><br><span class="line">    Word wJumpLimit;                            <span class="comment">//Jump limit</span></span><br><span class="line">    Word wOverdueLimit;                         <span class="comment">//Overdue limit</span></span><br><span class="line">    Byte wLock;                                 <span class="comment">//Resource lock</span></span><br><span class="line">&#125;TValueParameter, * pTValueParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Value parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor Rpm</span></span><br><span class="line">TValueParameter tvMotorActualRpm = &#123;.eSign         = SIGN_PLUS,</span><br><span class="line">                                    .wValue        = <span class="number">0</span>,                <span class="comment">//Unit: Rpm</span></span><br><span class="line">                                    .wPrevious     = <span class="number">0</span>,</span><br><span class="line">                                    .wDefault      = <span class="number">1000</span>,</span><br><span class="line">                                    .wCounter      = <span class="number">0</span>,                <span class="comment">//Unit: ms</span></span><br><span class="line">                                    .wUpperLimit   = <span class="number">2000</span>,</span><br><span class="line">                                    .wLowerLimit   = <span class="number">0</span>,</span><br><span class="line">                                    .wJumpLimit    = <span class="number">1000</span>,</span><br><span class="line">                                    .wOverdueLimit = <span class="number">0</span>,                <span class="comment">//Unit: s</span></span><br><span class="line">                                    .wLock           = LOCK_UNLOCK</span><br><span class="line">                                    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Speed</span></span><br><span class="line">TValueParameter tvSpeed = &#123;.eSign         = SIGN_PLUS,</span><br><span class="line">                            .wValue        = <span class="number">0</span>,                <span class="comment">//Unit: 0.1K/M</span></span><br><span class="line">                            .wPrevious     = <span class="number">0</span>,</span><br><span class="line">                            .wDefault      = <span class="number">400</span>,</span><br><span class="line">                            .wCounter      = <span class="number">0</span>,                <span class="comment">//Unit: ms</span></span><br><span class="line">                            .wUpperLimit   = <span class="number">200</span>,</span><br><span class="line">                            .wLowerLimit   = <span class="number">0</span>,</span><br><span class="line">                            .wJumpLimit    = <span class="number">1000</span>,</span><br><span class="line">                            .wOverdueLimit = <span class="number">0</span>,                <span class="comment">//Unit: s</span></span><br><span class="line">                            .wLock          = LOCK_UNLOCK</span><br><span class="line">                            &#125;;</span><br></pre></td></tr></table></figure>

<h2 id="6-怎么处理？-2"><a href="#6-怎么处理？-2" class="headerlink" title="6 怎么处理？"></a>6 怎么处理？</h2><h3 id="6-1-用断言检查永远不应该发生的错误-2"><a href="#6-1-用断言检查永远不应该发生的错误-2" class="headerlink" title="6.1 用断言检查永远不应该发生的错误"></a>6.1 用断言检查永远不应该发生的错误</h3><p>&amp;emsp;&amp;emsp;优点：错误定位，给代码调试带来极大的便利，创建更稳定、质量更好且不易于出错的代码。<br>&amp;emsp;&amp;emsp;缺点：频繁的调用会极大的影响程序的性能，增加额外的开销。<br>&amp;emsp;&amp;emsp;相比于函数，调用函数需要额外的队栈开销，宏函数节省开销但同一段代码存在多个副本。使用宏函数会引起很多副作用需要小心。<br>&amp;emsp;&amp;emsp;断言使用形式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#define NDEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _assert(bExpression)                                 \</span></span><br><span class="line"><span class="meta">do&#123;                                                          \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!(bExpression))                                  \</span></span><br><span class="line"><span class="meta">        &#123;                                                    \</span></span><br><span class="line"><span class="meta">            ErrorDeal();            <span class="comment">/*Error deal*/</span>           \</span></span><br><span class="line"><span class="meta">        &#125;                                                    \</span></span><br><span class="line"><span class="meta">&#125;while(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _assert(bExpression)        ((void)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    Byte byNumber1 = <span class="number">10</span>;</span><br><span class="line">    Byte byNumber2 = <span class="number">0</span>;</span><br><span class="line">    Byte byResult  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    _assert(<span class="number">0</span> != byNumber2);        <span class="comment">//Cannot be 0</span></span><br><span class="line"></span><br><span class="line">    byResult = byNumber1 / byNumber2;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, byNumber2);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:通过定义宏NDEBUG来控制断言的开启或关断。用于对较为严重的错误统一处理。另外，禁止把必须执行的代码放在断言中，断言关闭后功能将失效。</em><br>&amp;emsp;&amp;emsp;用断言的两种形式：</p>
<ul>
<li>断言一直开启。不论是调试版还是发行版都将断言函数开启。</li>
<li>可以在测试时启用断言，而在部署时禁用断言。同样，程序投入运行后，最终用户在遇到问题时可以重新起用断言。它可以快速发现并定位软件问题，同时对系统错误进行自动报警。断言可以对在系统中隐藏很深，用其它手段极难发现的问题可以用断言来进行定位，从而缩短软件问题定位时间，提高系统的可测性。实际应用时，可根据具体情况灵活地设计断言。</li>
</ul>
<blockquote>
<ul>
<li>前置条件断言：代码执行之前必须具备的特性。</li>
<li>后置条件断言：代码执行之后必须具备的特性。</li>
<li>前后不变断言：代码执行前后不能变化的特性。</li>
</ul>
</blockquote>
<h3 id="6-2-错误处理代码-2"><a href="#6-2-错误处理代码-2" class="headerlink" title="6.2 错误处理代码"></a>6.2 错误处理代码</h3><p>&amp;emsp;&amp;emsp;用错误处理代码来处理预期会发生的状况，用断言来处理绝不应该发生的状况。通常用错误处理来检查有害的输入数据。断言检查代码中的bug。<br>&amp;emsp;&amp;emsp;根据情形的不同，你可以返回中立值、换用下一个正确数据、返回与前次相同的值、换用最接近的有效值、在日志文件中记录警告信息、返回一个错误吗、调用错误处理子程序或对象、显示出错信息或者关闭程序——或把这些技术结合起来使用。</p>
<h4 id="6-2-1-返回中立值-2"><a href="#6-2-1-返回中立值-2" class="headerlink" title="6.2.1 返回中立值"></a>6.2.1 返回中立值</h4><p>&amp;emsp;&amp;emsp;对于一些“危害”并不严重的错误，最佳的做法就是继续执行操作并简单的返回一个没有危害的数值，比如数值0或空指针。</p>
<h4 id="6-2-2-给出一个修正的数据-2"><a href="#6-2-2-给出一个修正的数据-2" class="headerlink" title="6.2.2 给出一个修正的数据"></a>6.2.2 给出一个修正的数据</h4><p>&amp;emsp;&amp;emsp;对于can网络中不断更新但实时性要求并不高的数据，比如电机温度，短时间内数据丢失可是使用历史值。</p>
<h4 id="6-2-3-换用最接近的合法值-2"><a href="#6-2-3-换用最接近的合法值-2" class="headerlink" title="6.2.3 换用最接近的合法值"></a>6.2.3 换用最接近的合法值</h4><p>&amp;emsp;&amp;emsp;有些情况下可以换用最接近的合法值，当值大于上限或者小于下限值时，可以直接去上下限边界值。</p>
<h4 id="6-2-4-把警告信息记录到日志文件中-2"><a href="#6-2-4-把警告信息记录到日志文件中-2" class="headerlink" title="6.2.4 把警告信息记录到日志文件中"></a>6.2.4 把警告信息记录到日志文件中</h4><p>&amp;emsp;&amp;emsp;在检测到错误数据的时候，你可以选择在日志文件中记录一条警告信息，然后继续执行。这种方法可以同其他的错误处理技术结合使用。</p>
<h4 id="6-2-5-返回一个错误码-2"><a href="#6-2-5-返回一个错误码-2" class="headerlink" title="6.2.5 返回一个错误码"></a>6.2.5 返回一个错误码</h4><p>&amp;emsp;&amp;emsp;你可以决定只让系统的某些部分处理错误。其他部分则不在本地（局部）处理错误，而只是简单地报告有错误发生和发生的是何种错误，并信任调用链上游的某个子程序会处理该错误。通知系统其余部分已经发生错误可以采用下列方法：</p>
<blockquote>
<ul>
<li>设置一个状态变量的值。</li>
<li>用状态值作为函数的返回值。</li>
<li>用语言内建的异常机制抛出一个异常。</li>
</ul>
</blockquote>
<p>&amp;emsp;&amp;emsp;需要决定系统里哪部分应该直接处理错误，哪部分只是报告所发生的错误。对于安全性很重要的部分请确认调用的子程序总会检查返回的错误码。</p>
<h4 id="6-2-6-调用错误处理子程序或对象-2"><a href="#6-2-6-调用错误处理子程序或对象-2" class="headerlink" title="6.2.6 调用错误处理子程序或对象"></a>6.2.6 调用错误处理子程序或对象</h4><p>&amp;emsp;&amp;emsp;这种方法需要把错误处理都集中在一个全局的错误处理子程序或对象中，使得调试工作更为简单。而代价是整个程序都要知道这个集中点并与之紧密耦合。如果你想在其他系统中重用其中的某些代码，那就得把错误处理代码一并带过去。</p>
<h4 id="6-2-7-错误发生时发出错误信息-2"><a href="#6-2-7-错误发生时发出错误信息-2" class="headerlink" title="6.2.7 错误发生时发出错误信息"></a>6.2.7 错误发生时发出错误信息</h4><p>&amp;emsp;&amp;emsp;在调试模式下，当错误发生时为了帮助调试者尽快定位问题所在位置，可以通过打印显示或者报文将错误信息较为详细的发出。</p>
<h4 id="6-2-8-在局部处理错误-2"><a href="#6-2-8-在局部处理错误-2" class="headerlink" title="6.2.8 在局部处理错误"></a>6.2.8 在局部处理错误</h4><p>&amp;emsp;&amp;emsp;针对一些设计方案可能更适合在局部立即解决所有遇到的问题，具体的错误处理方法需要由该模块的设计者根据问题特点自行决定。这种方法给力模块程序员很大的灵活度，但这样做会导致错误记录和发出错误信息等代码散布到整个系统中，从而使得设计者还得考虑错误记录和错误发送相关的故障问题。能在局部立即解决的问题最好在内部立即解决。</p>
<h4 id="6-2-9-关闭或复位程序-2"><a href="#6-2-9-关闭或复位程序-2" class="headerlink" title="6.2.9 关闭或复位程序"></a>6.2.9 关闭或复位程序</h4><p>&amp;emsp;&amp;emsp;程序发生较为严重的错误时，比如堆栈溢出导致运行环境被破坏，所依附的操作系统严重故障，甚至收到恶意攻击时可能需要关闭和复位程序。<br>&amp;emsp;&amp;emsp;确定一种通用的处理错误参数的方法，是架构层次（或称高层次）的设计决策。如果在高层次处理错误，低层次只是汇报错误，那么就要确保高层次真的处理有错误！千万不要忽略错误信息，在函数的返回值返回故障信息，记得检查函数的返回值，即使你对某个函数有足够的自信。当有错误产生时，请记录并反馈对应的故障码和它描述的信息。</p>
<h3 id="6-3-异常-2"><a href="#6-3-异常-2" class="headerlink" title="6.3 异常"></a>6.3 异常</h3><p>&amp;emsp;&amp;emsp;如果一个子程序在运行过程中遇到了预料之外的情况，但这个情况又必须处理否则会影响功能的使用或程序的运行，这个时候需要子程序将异常抛出，把“问题”交给能解释并处理好它的代码。这属于一种错误处理机制。<br>&amp;emsp;&amp;emsp;能在局部处理的错误优选在局部处理，不能立即处理或局部无法处理的问题可抛出异常。不能用异常来推卸责任。异常处理函数需要了解大量子程序可能抛出何种错误并给出处理办法，弱化了程序的封装性，增加了程序的复杂程度。<br>&amp;emsp;&amp;emsp;每种异常都对应一种特殊情况，因此要确保异常信息中含有为理解异常抛出原因所需的充分信息，这对于读取异常信息的人来说是很有价值的。比如当发生数据越界时，除了抛出对应的故障码标识数据越界外，还应该给出上下界和非法的数据值。<br>&amp;emsp;&amp;emsp;总结：断言、错误处理代码、异常都需要有完备的故障捕获处理，以及故障信息的记录反馈。因此有必要考虑一种方法以确保异常处理的一致性，即创建一个集中的异常报告机制。这个机制需要能对异常信息进行一个集中的格式化和存储。c语言不像c++和java自带异常机制，但c语言可以借助setjmp和longjmp实现异常处理机制。实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> String        char *              <span class="comment">//Don&#x27;t use typedef</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception information structure-----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Exception</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> * description;</span><br><span class="line">&#125;TException, * pTException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception stack structure------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ExceptionFrame</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ExceptionFrame</span> * <span class="title">prev</span>;</span></span><br><span class="line">    jmp_buf env;                          <span class="comment">//Use in setjmp()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Exception information</span></span><br><span class="line">    <span class="type">const</span> TException * ptException;       <span class="comment">//About Exception</span></span><br><span class="line">    <span class="type">const</span> String strFileName;             <span class="comment">//File name</span></span><br><span class="line">    <span class="type">const</span> String strFunctionName;         <span class="comment">//Function name</span></span><br><span class="line">    Word wLineNumber;                     <span class="comment">//Line number</span></span><br><span class="line">&#125;TExceptionFrame, * pTExceptionFrame;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception status----------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">ExceptionStatus</span>&#123;</span></span><br><span class="line">    EXCEPT_ENTERED = <span class="number">0</span>,</span><br><span class="line">    EXCEPT_RAISED,</span><br><span class="line">    EXCEPT_HANDLED,</span><br><span class="line">    EXCEPT_FINALIZED</span><br><span class="line">&#125;EExceptionStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">*                try-catch-finally definition                *</span></span><br><span class="line"><span class="comment">*************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//try deal--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _try                                                                     \</span></span><br><span class="line"><span class="meta">&#123;                                                                                \</span></span><br><span class="line"><span class="meta">    Byte byExceptFlg;                                    <span class="comment">/*Return by setjmp()*/</span>  \</span></span><br><span class="line"><span class="meta">    TExceptionFrame tExceptionNode;                                              \</span></span><br><span class="line"><span class="meta">                                                                                 \</span></span><br><span class="line"><span class="meta">    <span class="comment">/*Push stack*/</span>                                                               \</span></span><br><span class="line"><span class="meta">    tExceptionNode.prev = ptExceptionStackTop;                                   \</span></span><br><span class="line"><span class="meta">    ptExceptionStackTop = &amp;tExceptionNode;                                       \</span></span><br><span class="line"><span class="meta">                                                                                 \</span></span><br><span class="line"><span class="meta">    byExceptFlg = setjmp(tExceptionNode.env);            <span class="comment">/*Set jump point*/</span>      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                                            \</span></span><br><span class="line"><span class="meta">    &#123;</span></span><br><span class="line">        <span class="comment">/*Here check and throw your exception*/</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//catch deal-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _catch(tException)                                                       \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>        \</span></span><br><span class="line"><span class="meta">        &#123;                                                                        \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span>  \</span></span><br><span class="line"><span class="meta">        &#125;                                                                        \</span></span><br><span class="line"><span class="meta">    &#125;                                                                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> <span class="keyword">if</span>(&amp;(tException) == tExceptionNode.ptException)                         \</span></span><br><span class="line"><span class="meta">    &#123;                                                                            \</span></span><br><span class="line"><span class="meta">        byExceptFlg = EXCEPT_HANDLED;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*Here deal your exception*/</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//finally deal------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _finally                                                                \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span> \</span></span><br><span class="line"><span class="meta">        &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">    &#123;                                                                           \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                                       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            byExceptFlg = EXCEPT_FINALIZED;                                     \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*Here must deal*/</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//end try deal-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _end_try                                                                \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span> \</span></span><br><span class="line"><span class="meta">        &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(EXCEPT_RAISED == byExceptFlg)                                            \</span></span><br><span class="line"><span class="meta">    &#123;                                                                           \</span></span><br><span class="line"><span class="meta">                                                                                \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">&#125;while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//_throw() deal------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _throw(tException) ExceptRaise(&amp;(tException), __FILE__, __FUNCTION__, __LINE__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">*                Exception deal function                     *</span></span><br><span class="line"><span class="comment">*************************************************************/</span></span><br><span class="line">pTExceptionFrame ptExceptionStackTop = <span class="literal">NULL</span>;            <span class="comment">//Stack top</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ExceptRaise</span><span class="params">(<span class="type">const</span> TException * <span class="type">const</span> ptException,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> String <span class="type">const</span> strFileName,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> String <span class="type">const</span> strFunctionN  ame,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> wLineNumber)</span></span><br><span class="line">&#123;</span><br><span class="line">    pTExceptionFrame pStackTop = ptExceptionStackTop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == ptException)                             <span class="comment">//Check NULL exception</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Do Something</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">NULL</span> == pStackTop)                           <span class="comment">//Check stack empty</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Do Something</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Record some information</span></span><br><span class="line">            pStackTop -&gt; ptException = ptException;</span><br><span class="line">            pStackTop -&gt; strFileName = strFileName;</span><br><span class="line">            pStackTop -&gt; strFunctionName = strFunctionName;</span><br><span class="line">            pStackTop -&gt; wLineNumber = wLineNumber;</span><br><span class="line"></span><br><span class="line">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;      <span class="comment">//Pop stack</span></span><br><span class="line"></span><br><span class="line">            longjmp(pStackTop -&gt; env, EXCEPT_RAISED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    TException A = &#123;<span class="string">&quot;A exception&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    _try</span><br><span class="line">    &#123;</span><br><span class="line">        _throw(A);</span><br><span class="line">    &#125;</span><br><span class="line">    _catch(A)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A exception\n&quot;</span>);</span><br><span class="line">    &#125;_end_try;</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&amp;emsp;&amp;emsp;预料之外的错误处理。<br>&amp;emsp;&amp;emsp;异常中没有捕获到的异常情况，我们认为是意外异常，发生意外异常时的一种常见做法是终止程序运行。</p>
<h3 id="6-4-隔栏-2"><a href="#6-4-隔栏-2" class="headerlink" title="6.4 隔栏"></a>6.4 隔栏</h3><p>&amp;emsp;&amp;emsp;数据源有两类，一类是外部传入一类是内部运算产生。由于外部数据的处理过程和存储环境对本模块设计者来说是模糊或不可见的，而内部数据处理直接或间接依赖于外部数据。因此我们假定外部数据是肮脏且不可信的，内部数据假定为干净（仅对少量安全性高数据检测）。不可信的外部数据传入内部需要一个统一数据清理的环节，这就是隔栏的作用。<br>&amp;emsp;&amp;emsp;隔栏与断言的关系：<br>&amp;emsp;&amp;emsp;隔栏的使用使断言和错误处理有了清晰的区分。隔栏外部的数据应该使用错误处理技术，在那里对数据做到任何假定都是不安全的。而隔栏内部的程序里就应该使用断言技术，因为传进来的数据都已在通过隔栏时被清理过了。如果隔栏内部的某个子程序检测到了错误的数据，那么应该是程序李的错误而不是数据里的错误。</p>
<p align="right">——《代码大全2》</p>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/grille.jpg" alt="grille.png" title="grille"></p>
<h3 id="6-5-错误日志处理。-2"><a href="#6-5-错误日志处理。-2" class="headerlink" title="6.5 错误日志处理。"></a>6.5 错误日志处理。</h3><p>&amp;emsp;&amp;emsp;随着项目规模的不断扩大，日志的应用对于维护程序的正常运行具有重要的意义。当一个程序崩溃时如果没有抛出异常信息，对于维护人员来说无法快速定位问题，更别谈去解决问题了。<br>日志时程序员解决问题的第一手资料。异常发生时，从别人口述的情况往往存在不准确或模糊，为了更好的解决问题我们需要当时发生了什么，用户当时做了什么操作，运行环境有无异常，数据有哪些变化，异常时否反复发生，是偶发还是有必然起因。若日志做了详细记录对于问题的定位和解决起到举足轻重的作用。</p>
<h4 id="6-5-1-日志的作用-2"><a href="#6-5-1-日志的作用-2" class="headerlink" title="6.5.1 日志的作用"></a>6.5.1 日志的作用</h4><ol>
<li>记录用户操作的审计日志，甚至就是监管部门的要求。</li>
<li>记录程序运行的流程。</li>
<li>记录数据的变化。</li>
<li>记录异常信息，快速定位问题根源。</li>
<li>数据统计和性能分析（程序性能或设备性能）。</li>
</ol>
<h4 id="6-5-2-如何做好程序日志-2"><a href="#6-5-2-如何做好程序日志-2" class="headerlink" title="6.5.2 如何做好程序日志"></a>6.5.2 如何做好程序日志</h4><ol>
<li><p>日志的可读性<br> &amp;emsp;&amp;emsp;看日志的是程序员，但并不一定是接触过相关模块或看过这部分源码的程序员。日志应该一路了然，信息详细但又不重复冗余。日志信息应该准确可靠，避免含糊不清的日志。</p>
</li>
<li><p>日志的资源消耗<br> &amp;emsp;&amp;emsp;日志的记录毫无疑问需要消耗资源，占用程序运行的时间资源、占用io口写入文件或数据库，占用磁盘或EE存储。日志信息应该简明扼要，避免打印无意义的日志，减少重复日志。日志应该做成滚动式，记录一段时间内的日志和错误等级高的日志，防止日志文件写满存储空间。</p>
</li>
<li><p>日志应该分等级<br> &amp;emsp;&amp;emsp;日志的等级可以分为FATAL、ERROR、INFO、DEBUG、TRACE。</p>
<ol>
<li><p>FATAL（致命）<br> FATAL是错误等级最高的重大错误，它的出现程序无法自我恢复，必须通过复位程序才能运行。该类错误应该记录错误码。</p>
</li>
<li><p>ERROR（错误）<br> 这类错误虽然发生，但可以通过程序来弥补或忽略来保证程序正常运行。该类错误需要记录错误码。</p>
</li>
<li><p>WARN（警告）<br> 表示会出现潜在错误的情形，比如参数未传入，使用默认了参数，参数持续时长一直未变化，这类错误虽异常但在程序员预期之内，并且程序做了充分的弥补措施。也建议记录错误码。</p>
</li>
<li><p>INFO（信息）<br> 用于记录程序的运行过程，打印一些程序运行中的重要信息，但要避免滥用。</p>
</li>
<li><p>DEBUG（调试）<br> 用于开发调试过程中，由程序员自由控制，具有较高灵活度。</p>
</li>
<li><p>TRACE（跟踪）<br> 一般不使用。用于跟踪函数的调用，不含变量只反应函数调用关系。</p>
</li>
</ol>
</li>
</ol>
<p>&amp;emsp;&amp;emsp;代码示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Log Level definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">LogLevel</span> &#123;</span>LOG_LEVEL_TRACE, LOG_LEVEL_DEBUG, LOG_LEVEL_INFO, LOG_LEVEL_WARN, LOG_LEVEL_ERROR, LOG_LEVEL_FATAL&#125; ELogLevel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义FATAL级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_FATAL(wFaultCode, strFormat, ...)         LogPrint(LOG_LEVEL_FATAL, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义ERROR级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_ERROR(wFaultCode, strFormat, ...)         LogPrint(LOG_LEVEL_ERROR, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义WARN级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_WARN(wFaultCode, strFormat, ...)          LogPrint(LOG_LEVEL_WARN, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义INFO级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_INFO(strFormat, ...)          LogPrint(LOG_LEVEL_INFO, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义DEBUG级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_DEBUG(strFormat, ...)         LogPrint(LOG_LEVEL_DEBUG, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义TRACE级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TRACE(strFormat, ...)         LogPrint(LOG_LEVEL_TRACE, <span class="string">&quot;[%s &lt;%d&gt;)](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure>
<p>&amp;emsp;&amp;emsp;输出结果展示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/Demo%20log.png" alt="Demo log.png" title="Demo log"></p>
<h3 id="6-6-错误码-1"><a href="#6-6-错误码-1" class="headerlink" title="6.6 错误码"></a>6.6 错误码</h3><p>&amp;emsp;&amp;emsp;软件运行中由于错误类型众多，为了对错误进行区分，系统设定了错误码（error code），软件通过内部的自检机制超出错误并抛出给开发人员，开发人员通过错误码快速分析错误原因。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Error description----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Belongs to</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AIR_COMPRESSOR                          (0X01 &lt;&lt; 24)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STEERING_MOTOR                          (0X02 &lt;&lt; 24)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Error level</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_1                           (0X01 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_2                           (0X02 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_3                           (0X03 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_4                           (0X04 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_5                           (0X05 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_6                           (0X06 &lt;&lt; 16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Error categories</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CATEGORIES_FUNCTION                     (0X01 &lt;&lt; 8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CATEGORIES_VALUE                        (0X02 &lt;&lt; 8)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//About function</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DOMAIN_ERROR                            (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X01)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RANGE_ERROR                             (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X02)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INVALID_ARGUMENT                        (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X03)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//About value</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OVERFLOW_ERROR                          (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X01)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERFLOW_ERROR                         (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X02)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OUT_OF_BOUNDS                           (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X03)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LENGTH_ERROR                            (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X04)</span></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<h3 id="6-7-调试log-1"><a href="#6-7-调试log-1" class="headerlink" title="6.7 调试log"></a>6.7 调试log</h3><p>&amp;emsp;&amp;emsp;跟踪代码运行轨迹，担当开发环境中的调试利器，提高开发效率，增强查错能力。<br>&amp;emsp;&amp;emsp;区别出产品代码与开发代码。产品级软件要求运行快速、节约资源、较高安全性，而开发中的软件可以运行缓慢、资源利用奢侈、提供一些额外的辅助调试的不安全操作。开发期间牺牲一些速度和资源换取使开发顺畅的内置工具，比如调试log，用于监视程序运行流程和数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> Uint16;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Function enum definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Switch</span> &#123;</span>DISABLE, ENABLE&#125; ESwitch; <span class="comment">//Switch variable</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG_LOG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG_LOG</span></span><br><span class="line">    <span class="comment">//Global variable-----------------------------------------------------------------</span></span><br><span class="line">    ESwitch bDebugSwtich = DISABLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Switch function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_SWITCH(bSwitch)        bDebugSwtich = (bSwitch)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Basic function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_ENTER_FUN()            (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. &lt;-----Enter function - %s -----&gt;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_EXIT_FUN()             (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. &lt;-----Exit function - %s -----&gt;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_PRINT(strFormat, ...)  (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ---&gt;&gt; &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_RETURN(Ret)            (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ===&gt;&gt; Ret: %#08X\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, Ret);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Extension function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_NUMBER(Number)         (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ---&gt;&gt; &quot;</span> #Number <span class="string">&quot; = %d\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, Number)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">//Switch function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_SWITCH(bSwitch)        ((void)0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Basic function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_ENTER_FUN()            ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_EXIT_FUN()             ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_PRINT(strFormat, ...)  ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_RETURN(Ret)            ((void)0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Extension function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_NUMBER(Number)         ((void)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> b = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> Return = <span class="number">0x00000001</span>;</span><br><span class="line"></span><br><span class="line">    DEBUG_SWITCH(ENABLE);</span><br><span class="line">    DEBUG_ENTER_FUN();</span><br><span class="line"></span><br><span class="line">    a = <span class="number">10</span>;</span><br><span class="line">    DEBUG_NUMBER(a);</span><br><span class="line">    b = <span class="number">2</span>;</span><br><span class="line">    DEBUG_NUMBER(b);</span><br><span class="line">    sum = a + b;</span><br><span class="line">    DEBUG_PRINT(<span class="string">&quot;%d  = %d + %d&quot;</span>, sum, a, b);</span><br><span class="line"></span><br><span class="line">    DEBUG_RETURN(Return);</span><br><span class="line">    DEBUG_EXIT_FUN();</span><br><span class="line">    DEBUG_SWITCH(DISABLE);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&amp;emsp;&amp;emsp;输出结果展示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/Debug%20log.png" alt="Debug log" title="Debug log"></p>
<h3 id="6-8-正确性与健壮性抉择。-1"><a href="#6-8-正确性与健壮性抉择。-1" class="headerlink" title="6.8 正确性与健壮性抉择。"></a>6.8 正确性与健壮性抉择。</h3><p>&amp;emsp;&amp;emsp;正确性意味着结果永远是正确的，如果出错，宁愿不给出结果也不要给定一个不准确的值。<br>&amp;emsp;&amp;emsp;健壮性意味着通过一些措施，保证软件能正常运行下去，即使有时候会有一些不准确的值出现。<br></br></p>
<h3 id="6-9-进攻式编程。-1"><a href="#6-9-进攻式编程。-1" class="headerlink" title="6.9 进攻式编程。"></a>6.9 进攻式编程。</h3><p>&amp;emsp;&amp;emsp;它的思想主要是提倡在开发阶段让问题尽可能显现出来，并且将问题扩大使得问题难以被忽视，这样才有助于问题不被忽视得到解决。而在产品运行时解决问题或让它能够自我纠正恢复。</p>
<h3 id="6-6-错误码-2"><a href="#6-6-错误码-2" class="headerlink" title="6.6 错误码"></a>6.6 错误码</h3><p>&amp;emsp;&amp;emsp;软件运行中由于错误类型众多，为了对错误进行区分，系统设定了错误码（error code），软件通过内部的自检机制超出错误并抛出给开发人员，开发人员通过错误码快速分析错误原因。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Error description----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Belongs to</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AIR_COMPRESSOR                          (0X01 &lt;&lt; 24)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STEERING_MOTOR                          (0X02 &lt;&lt; 24)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Error level</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_1                           (0X01 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_2                           (0X02 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_3                           (0X03 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_4                           (0X04 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_5                           (0X05 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_6                           (0X06 &lt;&lt; 16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Error categories</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CATEGORIES_FUNCTION                     (0X01 &lt;&lt; 8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CATEGORIES_VALUE                        (0X02 &lt;&lt; 8)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//About function</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DOMAIN_ERROR                            (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X01)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RANGE_ERROR                             (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X02)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INVALID_ARGUMENT                        (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X03)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//About value</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OVERFLOW_ERROR                          (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X01)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERFLOW_ERROR                         (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X02)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OUT_OF_BOUNDS                           (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X03)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LENGTH_ERROR                            (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X04)</span></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<h3 id="6-7-调试log-2"><a href="#6-7-调试log-2" class="headerlink" title="6.7 调试log"></a>6.7 调试log</h3><p>&amp;emsp;&amp;emsp;跟踪代码运行轨迹，担当开发环境中的调试利器，提高开发效率，增强查错能力。<br>&amp;emsp;&amp;emsp;区别出产品代码与开发代码。产品级软件要求运行快速、节约资源、较高安全性，而开发中的软件可以运行缓慢、资源利用奢侈、提供一些额外的辅助调试的不安全操作。开发期间牺牲一些速度和资源换取使开发顺畅的内置工具，比如调试log，用于监视程序运行流程和数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> Uint16;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Function enum definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Switch</span> &#123;</span>DISABLE, ENABLE&#125; ESwitch; <span class="comment">//Switch variable</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG_LOG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG_LOG</span></span><br><span class="line">    <span class="comment">//Global variable-----------------------------------------------------------------</span></span><br><span class="line">    ESwitch bDebugSwtich = DISABLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Switch function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_SWITCH(bSwitch)        bDebugSwtich = (bSwitch)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Basic function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_ENTER_FUN()            (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. &lt;-----Enter function - %s -----&gt;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_EXIT_FUN()             (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. &lt;-----Exit function - %s -----&gt;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_PRINT(strFormat, ...)  (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ---&gt;&gt; &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_RETURN(Ret)            (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ===&gt;&gt; Ret: %#08X\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, Ret);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Extension function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_NUMBER(Number)         (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ---&gt;&gt; &quot;</span> #Number <span class="string">&quot; = %d\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, Number)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">//Switch function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_SWITCH(bSwitch)        ((void)0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Basic function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_ENTER_FUN()            ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_EXIT_FUN()             ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_PRINT(strFormat, ...)  ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_RETURN(Ret)            ((void)0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Extension function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_NUMBER(Number)         ((void)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> b = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> Return = <span class="number">0x00000001</span>;</span><br><span class="line"></span><br><span class="line">    DEBUG_SWITCH(ENABLE);</span><br><span class="line">    DEBUG_ENTER_FUN();</span><br><span class="line"></span><br><span class="line">    a = <span class="number">10</span>;</span><br><span class="line">    DEBUG_NUMBER(a);</span><br><span class="line">    b = <span class="number">2</span>;</span><br><span class="line">    DEBUG_NUMBER(b);</span><br><span class="line">    sum = a + b;</span><br><span class="line">    DEBUG_PRINT(<span class="string">&quot;%d  = %d + %d&quot;</span>, sum, a, b);</span><br><span class="line"></span><br><span class="line">    DEBUG_RETURN(Return);</span><br><span class="line">    DEBUG_EXIT_FUN();</span><br><span class="line">    DEBUG_SWITCH(DISABLE);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&amp;emsp;&amp;emsp;输出结果展示：</p>
<h1 id="参数有效性检验-3"><a href="#参数有效性检验-3" class="headerlink" title="参数有效性检验"></a><center>参数有效性检验</center></h1><p><em>前言：</em><br>&amp;emsp;&amp;emsp;<em>2018-11-26天气凉，耗时三个周末完成这篇原创文章，记录下自己关于程序安全性方面的一些微薄见解。愿自己程序员之路越走越顺利，保持激情初心，不忘理想前行。</em></p>
<h2 id="1-问题：-3"><a href="#1-问题：-3" class="headerlink" title="1 问题："></a>1 问题：</h2><ul>
<li>为什么要检验？</li>
<li>哪些情况判为参数失效？</li>
<li>有哪些参数需要检验？</li>
<li>怎么检测？</li>
<li>在哪里检验？</li>
<li>怎么处理？</li>
</ul>
<h2 id="2-为什么要检验？-3"><a href="#2-为什么要检验？-3" class="headerlink" title="2 为什么要检验？"></a>2 为什么要检验？</h2><p>&amp;emsp;&amp;emsp;保护程序免糟非法输入数据的破坏，尽可能将异常数据对程序造成的影响控制在有限的范围内。<br>&amp;emsp;&amp;emsp;防御式编程主要思想：子程序应该不因传入错误数据而被破坏，哪怕是由其他子程序产生的错误数据。更一般地说，其核心思想是承认程序都会有问题，都需要被修改，聪明的程序员应该根据这一点来编程。<br>&amp;emsp;&amp;emsp;不管进来什么，好的程序都不会生成垃圾，而是做到“垃圾进，什么都不出”、“进来垃圾，出去是错误提示”或“不许垃圾进来”。</p>
<p align="right">——《代码大全2》第8章 防御式编程</p>

<h2 id="3-哪些情况判为参数失效？-3"><a href="#3-哪些情况判为参数失效？-3" class="headerlink" title="3 哪些情况判为参数失效？"></a>3 哪些情况判为参数失效？</h2><ul>
<li>参数越界失效：参数值不在预期范围内。比如参数值超过上下限，数组下标越界。</li>
<li>符号异常失效：指正负号异常，应该尽可能使用无符号类型。</li>
<li>空指针失效：传递空指针。</li>
<li>数据过期失效：原本实时更新的数据长期未变化。</li>
<li>跳变失效：数据波动异常的大或小。</li>
<li>关联数据异常失效：指两个以上的数据值之间有依赖和关联，当值不符合依赖关联性时认为失效。</li>
</ul>
<h2 id="4-有哪些参数需要检验？-3"><a href="#4-有哪些参数需要检验？-3" class="headerlink" title="4 有哪些参数需要检验？"></a>4 有哪些参数需要检验？</h2><p>&amp;emsp;&amp;emsp;最佳的形式是在一开始就不引入错误。</p>
<ul>
<li>从数据来源讲：<ul>
<li>检查来源于外部的数据的值。</li>
<li>检查子程序的输入参数的值。</li>
</ul>
</li>
</ul>
<p>&amp;emsp;&amp;emsp;应重点检查外部输入数据（网络通讯传入、上层或下层传入、硬件设备采集数据）外部传入的数据对本模块的程序员来说往往是模糊和不可操控的，内部数据也较多依赖于外部输入数据，因此重点检查外部数据。内部数据可以只检查较为复杂的算式或算法结果。</p>
<h2 id="5-怎么检测？-3"><a href="#5-怎么检测？-3" class="headerlink" title="5 怎么检测？"></a>5 怎么检测？</h2><p>&amp;emsp;&amp;emsp;对参数进行失效检验意味着需要存储有一些有关参数的信息，可以定义结构体化的参数。我们对参数进行分类如下：</p>
<h3 id="5-1-功能型参数-3"><a href="#5-1-功能型参数-3" class="headerlink" title="5.1 功能型参数"></a>5.1 功能型参数</h3><p>&amp;emsp;&amp;emsp;用于表示某项功能开关的参数，我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Type redefinition------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Function enum definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Switch</span> &#123;</span>DISABLE, ENABLE&#125; ESwitch; <span class="comment">//Switch variable</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Functional parameter structure-----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FunParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ESwitch eSwitch;               <span class="comment">//Value: ENABLE or DISABLE</span></span><br><span class="line">    ESwitch ePrevious;             <span class="comment">//Previous value</span></span><br><span class="line">    Word wCounter;                 <span class="comment">//Enable or Disable time</span></span><br><span class="line">&#125;TFunParameter, * pTFunParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//functional parameter initialization------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor head temperature</span></span><br><span class="line">TFunParameter tfHeadTemp = &#123;.eSwitch = ENABLE,</span><br><span class="line">                            .ePrevious = DISABLE,</span><br><span class="line">                            .wCounter = <span class="number">0</span></span><br><span class="line">                            &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测功能开关状态切换的跳变变化。功能有时需要记录开启或者关闭时间，因此直接将定时器封装进结构体使得参数关系紧密。</em></p>
<p>&amp;emsp;&amp;emsp;对功能型参数使用枚举类型因此不需要检测值越界失效和符号异常失效，重要的是检测关联数据异常失效。比如功能A和B为互斥关系，一次只能有一个功能打开或两个功能都关闭，再比如功能B开启前应该先打开功能A。功能开关较多，关联性强的情况下这样的检测变得重要。<br>&amp;emsp;&amp;emsp;对于功能型参数的关联性检测可以放到预处理时期由编译器检测，不用等到外出调试才发现错误。预处理指令不能检测变量，考虑到功能有效性一旦确当后不在修改，但又要满足调试时可能存在的对功能开关的修改，可以通过以下形式实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//General macro definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ENABLE                    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISABLE                   0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//The switch of Function-------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_HEAD_TEMP             ENABLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_OIL_PRESS             DISABLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUN_HEAD_TEMP_STOP        ENABLE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Functional correlation detection---------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span>((FUN_HEAD_TEMP == FUN_OIL_PRESS) &amp;&amp; (FUN_HEAD_TEMP == ENABLE))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">error</span> 油压与油温为互斥功能,不能同时开启。</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span>((FUN_HEAD_TEMP_STOP == ENABLE) &amp;&amp; (FUN_HEAD_TEMP == DISABLE))</span></span><br><span class="line">    <span class="meta">#<span class="keyword">error</span> 开启油温停机功能必须同时开启油温采样功能。</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//functional parameter initialization--------------------------------------------------------</span></span><br><span class="line">TFunParameter tfHeadTemp = &#123;.eSwitch = FUN_HEAD_TEMP, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;              <span class="comment">//Motor head temperature</span></span><br><span class="line">TFunParameter tfOilPress = &#123;.eSwitch = FUN_OIL_PRESS, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;              <span class="comment">//Oile press Function</span></span><br><span class="line">TFunParameter tfHeadTempStop = &#123;.eSwitch = FUN_HEAD_TEMP_STOP, .ePrevious = DISABLE, .wCounter = <span class="number">0</span>&#125;;     <span class="comment">//Motor Closed Function</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-状态型参数-3"><a href="#5-2-状态型参数-3" class="headerlink" title="5.2 状态型参数"></a>5.2 状态型参数</h3><p>&amp;emsp;&amp;emsp;状态型参数用于表示当前运行下的某种状态，是实时的因此不像常量宏可以用预处理指令检验。比如电机的开关波状态，阀门的开关状态，气压状态等。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Status enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">MotorPwm</span>&#123;</span>PWM_CLOSE, PWM_OPEN&#125;EMotorPwm;                 <span class="comment">//Motor Pwm Status</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">AirPressure</span>&#123;</span>AP_LOW, AP_NORMAL, AP_HIGH&#125;EAirPressure;    <span class="comment">//Air Pressure Status</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Status parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">StatusParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Byte byStatus;                           <span class="comment">//Current Status</span></span><br><span class="line">    Byte byPrevious;                         <span class="comment">//Previous value</span></span><br><span class="line">    Byte byFrequency;                        <span class="comment">//Status frequency</span></span><br><span class="line">    Word wCounter;                           <span class="comment">//Status duration time</span></span><br><span class="line">&#125;TStatusParameter, * pTStatusParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Status parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor Pwm Status</span></span><br><span class="line">TStatusParameter tsMotorPwm = &#123;.byStatus = PWM_OPEN,</span><br><span class="line">                                .byPrevious = PWM_CLOSE,</span><br><span class="line">                                .byFrequency = <span class="number">0</span>,</span><br><span class="line">                                .wCounter = <span class="number">0</span>                        <span class="comment">//Unit: s</span></span><br><span class="line">                                &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Air Pressure Status</span></span><br><span class="line">TStatusParameter tsAirPressure = &#123;.byStatus = AP_NORMAL,</span><br><span class="line">                                    .byPrevious = AP_NORMAL,</span><br><span class="line">                                    .byFrequency = <span class="number">0</span>,</span><br><span class="line">                                    .wCounter = <span class="number">0</span>                    <span class="comment">//Unit: ms</span></span><br><span class="line">                                    &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测状态转换的跳变变化。状态常常需要记录持续的时间，因此加入一个计数器可用于计时。在一段时间内有时还需要记录状态发生的次数，因此需要一个变量记录状态发生频度。</em></p>
<p>&amp;emsp;&amp;emsp;一种运行状态可能存在两种以上的状态值，且不同的状态值有不同的含义，因此无法用统一的枚举类型。对于一组状态值可以单独使用一组枚举表示，枚举的参数封装性更好，宏定义参数较“散”但省空间，综合多种因素在状态繁多的情况下我选择用封装性更好的枚举。<br>&amp;emsp;&amp;emsp;对于状态的检测，由于状态是随着程序运行实时变化的且不固定，因此无法在编译阶段对状态值的有效性检测。这就需要我们根据实际逻辑需要增加相应的检测代码。由于状态值都通过枚举定义好，因此不需要做参数越界失效和符号异常失效判断，状态值都是预知且固定的所以不需要跳变失效判断，其他失效根据实际情况添加检验代码。</p>
<h3 id="5-3-故障型参数。-3"><a href="#5-3-故障型参数。-3" class="headerlink" title="5.3 故障型参数。"></a>5.3 故障型参数。</h3><p>&amp;emsp;&amp;emsp;故障型参数用于记录当前或历史的故障发生情况，并决定是否要发出报警信号或停机等操作。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Unusual enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">UnusualSymbol</span>&#123;</span>ABNORMAL, NORMAL&#125;EUnusualSymbol;        <span class="comment">//Unusual state</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Unusual parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">UnusualParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    EUnusualSymbol eUnusualSymbol;                <span class="comment">//Unusual symbol</span></span><br><span class="line">    EUnusualSymbol ePrevious;                     <span class="comment">//Previous value</span></span><br><span class="line">    EUnusualSymbol eWarningSymbol;                <span class="comment">//Unusual Warning symbol</span></span><br><span class="line">    Byte byFrequency;                             <span class="comment">//Unusual frequency</span></span><br><span class="line">    Word wCounter;                                <span class="comment">//Unusual duration time</span></span><br><span class="line">&#125;TUnusualParameter, * pTUnusualParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Unusual parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Head temperature over</span></span><br><span class="line">TUnusualParameter tuHeadTempOver = &#123;.eUnusualSymbol   = NORMAL,</span><br><span class="line">                                    .ePrevious        = NORMAL,</span><br><span class="line">                                    .eWarningSymbol   = NORMAL,</span><br><span class="line">                                    .byFrequency      = <span class="number">0</span>,</span><br><span class="line">                                    .wCounter         = <span class="number">0</span>         <span class="comment">//Unit: ms</span></span><br><span class="line">                                    &#125;;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:定义历史值方便检测故障的发生和恢复变化。对于故障常常需要检测故障的持续时间和频度，因此定义相关成员变量。根据故障的持续时间和频度有时会引起其他动作，比如报警或停机，因此引入报警标志。</em></p>
<p>&amp;emsp;&amp;emsp;故障的状态只需要两种，即异常或正常，因此可以同意定义枚举类型。<br>&amp;emsp;&amp;emsp;对于故障的检测，由于故障是在程序运行中发生，因此对故障参数有效性的检测需要实时进行。由于故障参数有固定的枚举类型，因此不需要越界失效、符号异常、跳变失效判断，其他失效根据实际情况添加检验代码。</p>
<h3 id="5-4-普通值参数。-3"><a href="#5-4-普通值参数。-3" class="headerlink" title="5.4 普通值参数。"></a>5.4 普通值参数。</h3><p>&amp;emsp;&amp;emsp;普通值参数是较为庞大的一类参数，这类参数的值类型不一，值之间的关联性可以很复杂，每种值各有特点，参数的有效性检验很难做统一的处理。我们可以定义为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Sign enum definition-------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Sign</span>&#123;</span>SIGN_MINUS = <span class="number">-1</span>, SIGN_PLUS = <span class="number">1</span>&#125;ESign;          <span class="comment">//Unusual state</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Lock</span>&#123;</span>LOCK_UNLOCK = <span class="number">0</span>, LOCK_LOCK = <span class="number">1</span>&#125;ELock;          <span class="comment">//Resource lock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Value parameter structure definition----------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ValueParameter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ESign eSign;                                <span class="comment">//Value: SIGN_PLUS of SIGN_MINUS</span></span><br><span class="line">    Word wValue;                                <span class="comment">//Current value</span></span><br><span class="line">    Word wPrevious;                             <span class="comment">//Previous value</span></span><br><span class="line">    Word wDefault;                              <span class="comment">//Default value</span></span><br><span class="line">    Word wCounter;                              <span class="comment">//duration time</span></span><br><span class="line">    Word wUpperLimit;                           <span class="comment">//Upper limit</span></span><br><span class="line">    Word wLowerLimit;                           <span class="comment">//Lower limit</span></span><br><span class="line">    Word wJumpLimit;                            <span class="comment">//Jump limit</span></span><br><span class="line">    Word wOverdueLimit;                         <span class="comment">//Overdue limit</span></span><br><span class="line">    Byte wLock;                                 <span class="comment">//Resource lock</span></span><br><span class="line">&#125;TValueParameter, * pTValueParameter;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Value parameter initialization----------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Motor Rpm</span></span><br><span class="line">TValueParameter tvMotorActualRpm = &#123;.eSign         = SIGN_PLUS,</span><br><span class="line">                                    .wValue        = <span class="number">0</span>,                <span class="comment">//Unit: Rpm</span></span><br><span class="line">                                    .wPrevious     = <span class="number">0</span>,</span><br><span class="line">                                    .wDefault      = <span class="number">1000</span>,</span><br><span class="line">                                    .wCounter      = <span class="number">0</span>,                <span class="comment">//Unit: ms</span></span><br><span class="line">                                    .wUpperLimit   = <span class="number">2000</span>,</span><br><span class="line">                                    .wLowerLimit   = <span class="number">0</span>,</span><br><span class="line">                                    .wJumpLimit    = <span class="number">1000</span>,</span><br><span class="line">                                    .wOverdueLimit = <span class="number">0</span>,                <span class="comment">//Unit: s</span></span><br><span class="line">                                    .wLock           = LOCK_UNLOCK</span><br><span class="line">                                    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Speed</span></span><br><span class="line">TValueParameter tvSpeed = &#123;.eSign         = SIGN_PLUS,</span><br><span class="line">                            .wValue        = <span class="number">0</span>,                <span class="comment">//Unit: 0.1K/M</span></span><br><span class="line">                            .wPrevious     = <span class="number">0</span>,</span><br><span class="line">                            .wDefault      = <span class="number">400</span>,</span><br><span class="line">                            .wCounter      = <span class="number">0</span>,                <span class="comment">//Unit: ms</span></span><br><span class="line">                            .wUpperLimit   = <span class="number">200</span>,</span><br><span class="line">                            .wLowerLimit   = <span class="number">0</span>,</span><br><span class="line">                            .wJumpLimit    = <span class="number">1000</span>,</span><br><span class="line">                            .wOverdueLimit = <span class="number">0</span>,                <span class="comment">//Unit: s</span></span><br><span class="line">                            .wLock          = LOCK_UNLOCK</span><br><span class="line">                            &#125;;</span><br></pre></td></tr></table></figure>

<h2 id="6-怎么处理？-3"><a href="#6-怎么处理？-3" class="headerlink" title="6 怎么处理？"></a>6 怎么处理？</h2><h3 id="6-1-用断言检查永远不应该发生的错误-3"><a href="#6-1-用断言检查永远不应该发生的错误-3" class="headerlink" title="6.1 用断言检查永远不应该发生的错误"></a>6.1 用断言检查永远不应该发生的错误</h3><p>&amp;emsp;&amp;emsp;优点：错误定位，给代码调试带来极大的便利，创建更稳定、质量更好且不易于出错的代码。<br>&amp;emsp;&amp;emsp;缺点：频繁的调用会极大的影响程序的性能，增加额外的开销。<br>&amp;emsp;&amp;emsp;相比于函数，调用函数需要额外的队栈开销，宏函数节省开销但同一段代码存在多个副本。使用宏函数会引起很多副作用需要小心。<br>&amp;emsp;&amp;emsp;断言使用形式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#define NDEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _assert(bExpression)                                 \</span></span><br><span class="line"><span class="meta">do&#123;                                                          \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!(bExpression))                                  \</span></span><br><span class="line"><span class="meta">        &#123;                                                    \</span></span><br><span class="line"><span class="meta">            ErrorDeal();            <span class="comment">/*Error deal*/</span>           \</span></span><br><span class="line"><span class="meta">        &#125;                                                    \</span></span><br><span class="line"><span class="meta">&#125;while(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _assert(bExpression)        ((void)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    Byte byNumber1 = <span class="number">10</span>;</span><br><span class="line">    Byte byNumber2 = <span class="number">0</span>;</span><br><span class="line">    Byte byResult  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    _assert(<span class="number">0</span> != byNumber2);        <span class="comment">//Cannot be 0</span></span><br><span class="line"></span><br><span class="line">    byResult = byNumber1 / byNumber2;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, byNumber2);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>&amp;emsp;&amp;emsp;note:通过定义宏NDEBUG来控制断言的开启或关断。用于对较为严重的错误统一处理。另外，禁止把必须执行的代码放在断言中，断言关闭后功能将失效。</em><br>&amp;emsp;&amp;emsp;用断言的两种形式：</p>
<ul>
<li>断言一直开启。不论是调试版还是发行版都将断言函数开启。</li>
<li>可以在测试时启用断言，而在部署时禁用断言。同样，程序投入运行后，最终用户在遇到问题时可以重新起用断言。它可以快速发现并定位软件问题，同时对系统错误进行自动报警。断言可以对在系统中隐藏很深，用其它手段极难发现的问题可以用断言来进行定位，从而缩短软件问题定位时间，提高系统的可测性。实际应用时，可根据具体情况灵活地设计断言。</li>
</ul>
<blockquote>
<ul>
<li>前置条件断言：代码执行之前必须具备的特性。</li>
<li>后置条件断言：代码执行之后必须具备的特性。</li>
<li>前后不变断言：代码执行前后不能变化的特性。</li>
</ul>
</blockquote>
<h3 id="6-2-错误处理代码-3"><a href="#6-2-错误处理代码-3" class="headerlink" title="6.2 错误处理代码"></a>6.2 错误处理代码</h3><p>&amp;emsp;&amp;emsp;用错误处理代码来处理预期会发生的状况，用断言来处理绝不应该发生的状况。通常用错误处理来检查有害的输入数据。断言检查代码中的bug。<br>&amp;emsp;&amp;emsp;根据情形的不同，你可以返回中立值、换用下一个正确数据、返回与前次相同的值、换用最接近的有效值、在日志文件中记录警告信息、返回一个错误吗、调用错误处理子程序或对象、显示出错信息或者关闭程序——或把这些技术结合起来使用。</p>
<h4 id="6-2-1-返回中立值-3"><a href="#6-2-1-返回中立值-3" class="headerlink" title="6.2.1 返回中立值"></a>6.2.1 返回中立值</h4><p>&amp;emsp;&amp;emsp;对于一些“危害”并不严重的错误，最佳的做法就是继续执行操作并简单的返回一个没有危害的数值，比如数值0或空指针。</p>
<h4 id="6-2-2-给出一个修正的数据-3"><a href="#6-2-2-给出一个修正的数据-3" class="headerlink" title="6.2.2 给出一个修正的数据"></a>6.2.2 给出一个修正的数据</h4><p>&amp;emsp;&amp;emsp;对于can网络中不断更新但实时性要求并不高的数据，比如电机温度，短时间内数据丢失可是使用历史值。</p>
<h4 id="6-2-3-换用最接近的合法值-3"><a href="#6-2-3-换用最接近的合法值-3" class="headerlink" title="6.2.3 换用最接近的合法值"></a>6.2.3 换用最接近的合法值</h4><p>&amp;emsp;&amp;emsp;有些情况下可以换用最接近的合法值，当值大于上限或者小于下限值时，可以直接去上下限边界值。</p>
<h4 id="6-2-4-把警告信息记录到日志文件中-3"><a href="#6-2-4-把警告信息记录到日志文件中-3" class="headerlink" title="6.2.4 把警告信息记录到日志文件中"></a>6.2.4 把警告信息记录到日志文件中</h4><p>&amp;emsp;&amp;emsp;在检测到错误数据的时候，你可以选择在日志文件中记录一条警告信息，然后继续执行。这种方法可以同其他的错误处理技术结合使用。</p>
<h4 id="6-2-5-返回一个错误码-3"><a href="#6-2-5-返回一个错误码-3" class="headerlink" title="6.2.5 返回一个错误码"></a>6.2.5 返回一个错误码</h4><p>&amp;emsp;&amp;emsp;你可以决定只让系统的某些部分处理错误。其他部分则不在本地（局部）处理错误，而只是简单地报告有错误发生和发生的是何种错误，并信任调用链上游的某个子程序会处理该错误。通知系统其余部分已经发生错误可以采用下列方法：</p>
<blockquote>
<ul>
<li>设置一个状态变量的值。</li>
<li>用状态值作为函数的返回值。</li>
<li>用语言内建的异常机制抛出一个异常。</li>
</ul>
</blockquote>
<p>&amp;emsp;&amp;emsp;需要决定系统里哪部分应该直接处理错误，哪部分只是报告所发生的错误。对于安全性很重要的部分请确认调用的子程序总会检查返回的错误码。</p>
<h4 id="6-2-6-调用错误处理子程序或对象-3"><a href="#6-2-6-调用错误处理子程序或对象-3" class="headerlink" title="6.2.6 调用错误处理子程序或对象"></a>6.2.6 调用错误处理子程序或对象</h4><p>&amp;emsp;&amp;emsp;这种方法需要把错误处理都集中在一个全局的错误处理子程序或对象中，使得调试工作更为简单。而代价是整个程序都要知道这个集中点并与之紧密耦合。如果你想在其他系统中重用其中的某些代码，那就得把错误处理代码一并带过去。</p>
<h4 id="6-2-7-错误发生时发出错误信息-3"><a href="#6-2-7-错误发生时发出错误信息-3" class="headerlink" title="6.2.7 错误发生时发出错误信息"></a>6.2.7 错误发生时发出错误信息</h4><p>&amp;emsp;&amp;emsp;在调试模式下，当错误发生时为了帮助调试者尽快定位问题所在位置，可以通过打印显示或者报文将错误信息较为详细的发出。</p>
<h4 id="6-2-8-在局部处理错误-3"><a href="#6-2-8-在局部处理错误-3" class="headerlink" title="6.2.8 在局部处理错误"></a>6.2.8 在局部处理错误</h4><p>&amp;emsp;&amp;emsp;针对一些设计方案可能更适合在局部立即解决所有遇到的问题，具体的错误处理方法需要由该模块的设计者根据问题特点自行决定。这种方法给力模块程序员很大的灵活度，但这样做会导致错误记录和发出错误信息等代码散布到整个系统中，从而使得设计者还得考虑错误记录和错误发送相关的故障问题。能在局部立即解决的问题最好在内部立即解决。</p>
<h4 id="6-2-9-关闭或复位程序-3"><a href="#6-2-9-关闭或复位程序-3" class="headerlink" title="6.2.9 关闭或复位程序"></a>6.2.9 关闭或复位程序</h4><p>&amp;emsp;&amp;emsp;程序发生较为严重的错误时，比如堆栈溢出导致运行环境被破坏，所依附的操作系统严重故障，甚至收到恶意攻击时可能需要关闭和复位程序。<br>&amp;emsp;&amp;emsp;确定一种通用的处理错误参数的方法，是架构层次（或称高层次）的设计决策。如果在高层次处理错误，低层次只是汇报错误，那么就要确保高层次真的处理有错误！千万不要忽略错误信息，在函数的返回值返回故障信息，记得检查函数的返回值，即使你对某个函数有足够的自信。当有错误产生时，请记录并反馈对应的故障码和它描述的信息。</p>
<h3 id="6-3-异常-3"><a href="#6-3-异常-3" class="headerlink" title="6.3 异常"></a>6.3 异常</h3><p>&amp;emsp;&amp;emsp;如果一个子程序在运行过程中遇到了预料之外的情况，但这个情况又必须处理否则会影响功能的使用或程序的运行，这个时候需要子程序将异常抛出，把“问题”交给能解释并处理好它的代码。这属于一种错误处理机制。<br>&amp;emsp;&amp;emsp;能在局部处理的错误优选在局部处理，不能立即处理或局部无法处理的问题可抛出异常。不能用异常来推卸责任。异常处理函数需要了解大量子程序可能抛出何种错误并给出处理办法，弱化了程序的封装性，增加了程序的复杂程度。<br>&amp;emsp;&amp;emsp;每种异常都对应一种特殊情况，因此要确保异常信息中含有为理解异常抛出原因所需的充分信息，这对于读取异常信息的人来说是很有价值的。比如当发生数据越界时，除了抛出对应的故障码标识数据越界外，还应该给出上下界和非法的数据值。<br>&amp;emsp;&amp;emsp;总结：断言、错误处理代码、异常都需要有完备的故障捕获处理，以及故障信息的记录反馈。因此有必要考虑一种方法以确保异常处理的一致性，即创建一个集中的异常报告机制。这个机制需要能对异常信息进行一个集中的格式化和存储。c语言不像c++和java自带异常机制，但c语言可以借助setjmp和longjmp实现异常处理机制。实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> String        char *              <span class="comment">//Don&#x27;t use typedef</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception information structure-----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Exception</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> * description;</span><br><span class="line">&#125;TException, * pTException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception stack structure------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ExceptionFrame</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ExceptionFrame</span> * <span class="title">prev</span>;</span></span><br><span class="line">    jmp_buf env;                          <span class="comment">//Use in setjmp()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Exception information</span></span><br><span class="line">    <span class="type">const</span> TException * ptException;       <span class="comment">//About Exception</span></span><br><span class="line">    <span class="type">const</span> String strFileName;             <span class="comment">//File name</span></span><br><span class="line">    <span class="type">const</span> String strFunctionName;         <span class="comment">//Function name</span></span><br><span class="line">    Word wLineNumber;                     <span class="comment">//Line number</span></span><br><span class="line">&#125;TExceptionFrame, * pTExceptionFrame;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception status----------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">ExceptionStatus</span>&#123;</span></span><br><span class="line">    EXCEPT_ENTERED = <span class="number">0</span>,</span><br><span class="line">    EXCEPT_RAISED,</span><br><span class="line">    EXCEPT_HANDLED,</span><br><span class="line">    EXCEPT_FINALIZED</span><br><span class="line">&#125;EExceptionStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">*                try-catch-finally definition                *</span></span><br><span class="line"><span class="comment">*************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//try deal--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _try                                                                     \</span></span><br><span class="line"><span class="meta">&#123;                                                                                \</span></span><br><span class="line"><span class="meta">    Byte byExceptFlg;                                    <span class="comment">/*Return by setjmp()*/</span>  \</span></span><br><span class="line"><span class="meta">    TExceptionFrame tExceptionNode;                                              \</span></span><br><span class="line"><span class="meta">                                                                                 \</span></span><br><span class="line"><span class="meta">    <span class="comment">/*Push stack*/</span>                                                               \</span></span><br><span class="line"><span class="meta">    tExceptionNode.prev = ptExceptionStackTop;                                   \</span></span><br><span class="line"><span class="meta">    ptExceptionStackTop = &amp;tExceptionNode;                                       \</span></span><br><span class="line"><span class="meta">                                                                                 \</span></span><br><span class="line"><span class="meta">    byExceptFlg = setjmp(tExceptionNode.env);            <span class="comment">/*Set jump point*/</span>      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                                            \</span></span><br><span class="line"><span class="meta">    &#123;</span></span><br><span class="line">        <span class="comment">/*Here check and throw your exception*/</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//catch deal-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _catch(tException)                                                       \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>        \</span></span><br><span class="line"><span class="meta">        &#123;                                                                        \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span>  \</span></span><br><span class="line"><span class="meta">        &#125;                                                                        \</span></span><br><span class="line"><span class="meta">    &#125;                                                                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> <span class="keyword">if</span>(&amp;(tException) == tExceptionNode.ptException)                         \</span></span><br><span class="line"><span class="meta">    &#123;                                                                            \</span></span><br><span class="line"><span class="meta">        byExceptFlg = EXCEPT_HANDLED;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*Here deal your exception*/</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//finally deal------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _finally                                                                \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span> \</span></span><br><span class="line"><span class="meta">        &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">    &#123;                                                                           \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                                       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            byExceptFlg = EXCEPT_FINALIZED;                                     \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*Here must deal*/</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//end try deal-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _end_try                                                                \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span>(EXCEPT_ENTERED == byExceptFlg)                <span class="comment">/*No Exception*/</span>       \</span></span><br><span class="line"><span class="meta">        &#123;                                                                       \</span></span><br><span class="line"><span class="meta">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;    <span class="comment">/*Pop stack*/</span> \</span></span><br><span class="line"><span class="meta">        &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span>(EXCEPT_RAISED == byExceptFlg)                                            \</span></span><br><span class="line"><span class="meta">    &#123;                                                                           \</span></span><br><span class="line"><span class="meta">                                                                                \</span></span><br><span class="line"><span class="meta">    &#125;                                                                           \</span></span><br><span class="line"><span class="meta">&#125;while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//_throw() deal------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _throw(tException) ExceptRaise(&amp;(tException), __FILE__, __FUNCTION__, __LINE__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************</span></span><br><span class="line"><span class="comment">*                Exception deal function                     *</span></span><br><span class="line"><span class="comment">*************************************************************/</span></span><br><span class="line">pTExceptionFrame ptExceptionStackTop = <span class="literal">NULL</span>;            <span class="comment">//Stack top</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ExceptRaise</span><span class="params">(<span class="type">const</span> TException * <span class="type">const</span> ptException,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> String <span class="type">const</span> strFileName,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> String <span class="type">const</span> strFunctionN  ame,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> wLineNumber)</span></span><br><span class="line">&#123;</span><br><span class="line">    pTExceptionFrame pStackTop = ptExceptionStackTop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == ptException)                             <span class="comment">//Check NULL exception</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Do Something</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">NULL</span> == pStackTop)                           <span class="comment">//Check stack empty</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Do Something</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Record some information</span></span><br><span class="line">            pStackTop -&gt; ptException = ptException;</span><br><span class="line">            pStackTop -&gt; strFileName = strFileName;</span><br><span class="line">            pStackTop -&gt; strFunctionName = strFunctionName;</span><br><span class="line">            pStackTop -&gt; wLineNumber = wLineNumber;</span><br><span class="line"></span><br><span class="line">            ptExceptionStackTop = ptExceptionStackTop -&gt; prev;      <span class="comment">//Pop stack</span></span><br><span class="line"></span><br><span class="line">            longjmp(pStackTop -&gt; env, EXCEPT_RAISED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    TException A = &#123;<span class="string">&quot;A exception&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    _try</span><br><span class="line">    &#123;</span><br><span class="line">        _throw(A);</span><br><span class="line">    &#125;</span><br><span class="line">    _catch(A)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A exception\n&quot;</span>);</span><br><span class="line">    &#125;_end_try;</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&amp;emsp;&amp;emsp;预料之外的错误处理。<br>&amp;emsp;&amp;emsp;异常中没有捕获到的异常情况，我们认为是意外异常，发生意外异常时的一种常见做法是终止程序运行。</p>
<h3 id="6-4-隔栏-3"><a href="#6-4-隔栏-3" class="headerlink" title="6.4 隔栏"></a>6.4 隔栏</h3><p>&amp;emsp;&amp;emsp;数据源有两类，一类是外部传入一类是内部运算产生。由于外部数据的处理过程和存储环境对本模块设计者来说是模糊或不可见的，而内部数据处理直接或间接依赖于外部数据。因此我们假定外部数据是肮脏且不可信的，内部数据假定为干净（仅对少量安全性高数据检测）。不可信的外部数据传入内部需要一个统一数据清理的环节，这就是隔栏的作用。<br>&amp;emsp;&amp;emsp;隔栏与断言的关系：<br>&amp;emsp;&amp;emsp;隔栏的使用使断言和错误处理有了清晰的区分。隔栏外部的数据应该使用错误处理技术，在那里对数据做到任何假定都是不安全的。而隔栏内部的程序里就应该使用断言技术，因为传进来的数据都已在通过隔栏时被清理过了。如果隔栏内部的某个子程序检测到了错误的数据，那么应该是程序李的错误而不是数据里的错误。</p>
<p align="right">——《代码大全2》</p>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/grille.jpg" alt="grille.png" title="grille"></p>
<h3 id="6-5-错误日志处理。-3"><a href="#6-5-错误日志处理。-3" class="headerlink" title="6.5 错误日志处理。"></a>6.5 错误日志处理。</h3><p>&amp;emsp;&amp;emsp;随着项目规模的不断扩大，日志的应用对于维护程序的正常运行具有重要的意义。当一个程序崩溃时如果没有抛出异常信息，对于维护人员来说无法快速定位问题，更别谈去解决问题了。<br>日志时程序员解决问题的第一手资料。异常发生时，从别人口述的情况往往存在不准确或模糊，为了更好的解决问题我们需要当时发生了什么，用户当时做了什么操作，运行环境有无异常，数据有哪些变化，异常时否反复发生，是偶发还是有必然起因。若日志做了详细记录对于问题的定位和解决起到举足轻重的作用。</p>
<h4 id="6-5-1-日志的作用-3"><a href="#6-5-1-日志的作用-3" class="headerlink" title="6.5.1 日志的作用"></a>6.5.1 日志的作用</h4><ol>
<li>记录用户操作的审计日志，甚至就是监管部门的要求。</li>
<li>记录程序运行的流程。</li>
<li>记录数据的变化。</li>
<li>记录异常信息，快速定位问题根源。</li>
<li>数据统计和性能分析（程序性能或设备性能）。</li>
</ol>
<h4 id="6-5-2-如何做好程序日志-3"><a href="#6-5-2-如何做好程序日志-3" class="headerlink" title="6.5.2 如何做好程序日志"></a>6.5.2 如何做好程序日志</h4><ol>
<li><p>日志的可读性<br> &amp;emsp;&amp;emsp;看日志的是程序员，但并不一定是接触过相关模块或看过这部分源码的程序员。日志应该一路了然，信息详细但又不重复冗余。日志信息应该准确可靠，避免含糊不清的日志。</p>
</li>
<li><p>日志的资源消耗<br> &amp;emsp;&amp;emsp;日志的记录毫无疑问需要消耗资源，占用程序运行的时间资源、占用io口写入文件或数据库，占用磁盘或EE存储。日志信息应该简明扼要，避免打印无意义的日志，减少重复日志。日志应该做成滚动式，记录一段时间内的日志和错误等级高的日志，防止日志文件写满存储空间。</p>
</li>
<li><p>日志应该分等级<br> &amp;emsp;&amp;emsp;日志的等级可以分为FATAL、ERROR、INFO、DEBUG、TRACE。</p>
<ol>
<li><p>FATAL（致命）<br> FATAL是错误等级最高的重大错误，它的出现程序无法自我恢复，必须通过复位程序才能运行。该类错误应该记录错误码。</p>
</li>
<li><p>ERROR（错误）<br> 这类错误虽然发生，但可以通过程序来弥补或忽略来保证程序正常运行。该类错误需要记录错误码。</p>
</li>
<li><p>WARN（警告）<br> 表示会出现潜在错误的情形，比如参数未传入，使用默认了参数，参数持续时长一直未变化，这类错误虽异常但在程序员预期之内，并且程序做了充分的弥补措施。也建议记录错误码。</p>
</li>
<li><p>INFO（信息）<br> 用于记录程序的运行过程，打印一些程序运行中的重要信息，但要避免滥用。</p>
</li>
<li><p>DEBUG（调试）<br> 用于开发调试过程中，由程序员自由控制，具有较高灵活度。</p>
</li>
<li><p>TRACE（跟踪）<br> 一般不使用。用于跟踪函数的调用，不含变量只反应函数调用关系。</p>
</li>
</ol>
</li>
</ol>
<p>&amp;emsp;&amp;emsp;代码示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Log Level definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">LogLevel</span> &#123;</span>LOG_LEVEL_TRACE, LOG_LEVEL_DEBUG, LOG_LEVEL_INFO, LOG_LEVEL_WARN, LOG_LEVEL_ERROR, LOG_LEVEL_FATAL&#125; ELogLevel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义FATAL级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_FATAL(wFaultCode, strFormat, ...)         LogPrint(LOG_LEVEL_FATAL, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义ERROR级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_ERROR(wFaultCode, strFormat, ...)         LogPrint(LOG_LEVEL_ERROR, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义WARN级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_WARN(wFaultCode, strFormat, ...)          LogPrint(LOG_LEVEL_WARN, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> <span class="string">&quot;[%#08X]&quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, wFaultCode, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义INFO级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_INFO(strFormat, ...)          LogPrint(LOG_LEVEL_INFO, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义DEBUG级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_DEBUG(strFormat, ...)         LogPrint(LOG_LEVEL_DEBUG, <span class="string">&quot;[%s &lt;%d&gt;](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义TRACE级别输出宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TRACE(strFormat, ...)         LogPrint(LOG_LEVEL_TRACE, <span class="string">&quot;[%s &lt;%d&gt;)](%s) &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure>
<p>&amp;emsp;&amp;emsp;输出结果展示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/Demo%20log.png" alt="Demo log.png" title="Demo log"></p>
<h3 id="6-6-错误码-3"><a href="#6-6-错误码-3" class="headerlink" title="6.6 错误码"></a>6.6 错误码</h3><p>&amp;emsp;&amp;emsp;软件运行中由于错误类型众多，为了对错误进行区分，系统设定了错误码（error code），软件通过内部的自检机制超出错误并抛出给开发人员，开发人员通过错误码快速分析错误原因。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Error description----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Belongs to</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AIR_COMPRESSOR                          (0X01 &lt;&lt; 24)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STEERING_MOTOR                          (0X02 &lt;&lt; 24)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Error level</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_1                           (0X01 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_2                           (0X02 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_3                           (0X03 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_4                           (0X04 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_5                           (0X05 &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_LEVEL_6                           (0X06 &lt;&lt; 16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Error categories</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CATEGORIES_FUNCTION                     (0X01 &lt;&lt; 8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CATEGORIES_VALUE                        (0X02 &lt;&lt; 8)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//About function</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DOMAIN_ERROR                            (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X01)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RANGE_ERROR                             (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X02)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INVALID_ARGUMENT                        (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_FUNCTION | 0X03)</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//About value</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OVERFLOW_ERROR                          (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X01)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERFLOW_ERROR                         (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X02)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OUT_OF_BOUNDS                           (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X03)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LENGTH_ERROR                            (AIR_COMPRESSOR | ERROR_LEVEL_4 | CATEGORIES_VALUE | 0X04)</span></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<h3 id="6-7-调试log-3"><a href="#6-7-调试log-3" class="headerlink" title="6.7 调试log"></a>6.7 调试log</h3><p>&amp;emsp;&amp;emsp;跟踪代码运行轨迹，担当开发环境中的调试利器，提高开发效率，增强查错能力。<br>&amp;emsp;&amp;emsp;区别出产品代码与开发代码。产品级软件要求运行快速、节约资源、较高安全性，而开发中的软件可以运行缓慢、资源利用奢侈、提供一些额外的辅助调试的不安全操作。开发期间牺牲一些速度和资源换取使开发顺畅的内置工具，比如调试log，用于监视程序运行流程和数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> Uint16;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> Byte;</span><br><span class="line"><span class="keyword">typedef</span> Uint16        Word;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Function enum definition-----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">Switch</span> &#123;</span>DISABLE, ENABLE&#125; ESwitch; <span class="comment">//Switch variable</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG_LOG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG_LOG</span></span><br><span class="line">    <span class="comment">//Global variable-----------------------------------------------------------------</span></span><br><span class="line">    ESwitch bDebugSwtich = DISABLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Switch function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_SWITCH(bSwitch)        bDebugSwtich = (bSwitch)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Basic function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_ENTER_FUN()            (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. &lt;-----Enter function - %s -----&gt;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_EXIT_FUN()             (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. &lt;-----Exit function - %s -----&gt;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_PRINT(strFormat, ...)  (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ---&gt;&gt; &quot;</span> strFormat <span class="string">&quot;\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, ##__VA_ARGS__)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_RETURN(Ret)            (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ===&gt;&gt; Ret: %#08X\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, Ret);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Extension function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_NUMBER(Number)         (DISABLE == bDebugSwtich) ? ((void)0) : printf(<span class="string">&quot;File: %s. -Line: %d. -Function: %s. ---&gt;&gt; &quot;</span> #Number <span class="string">&quot; = %d\n&quot;</span>, __FILE__, __LINE__, __FUNCTION__, Number)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">//Switch function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_SWITCH(bSwitch)        ((void)0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Basic function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_ENTER_FUN()            ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_EXIT_FUN()             ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_PRINT(strFormat, ...)  ((void)0)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_RETURN(Ret)            ((void)0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Extension function</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEBUG_NUMBER(Number)         ((void)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> b = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> Return = <span class="number">0x00000001</span>;</span><br><span class="line"></span><br><span class="line">    DEBUG_SWITCH(ENABLE);</span><br><span class="line">    DEBUG_ENTER_FUN();</span><br><span class="line"></span><br><span class="line">    a = <span class="number">10</span>;</span><br><span class="line">    DEBUG_NUMBER(a);</span><br><span class="line">    b = <span class="number">2</span>;</span><br><span class="line">    DEBUG_NUMBER(b);</span><br><span class="line">    sum = a + b;</span><br><span class="line">    DEBUG_PRINT(<span class="string">&quot;%d  = %d + %d&quot;</span>, sum, a, b);</span><br><span class="line"></span><br><span class="line">    DEBUG_RETURN(Return);</span><br><span class="line">    DEBUG_EXIT_FUN();</span><br><span class="line">    DEBUG_SWITCH(DISABLE);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&amp;emsp;&amp;emsp;输出结果展示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/Debug%20log.png" alt="Debug log" title="Debug log"></p>
<h3 id="6-8-正确性与健壮性抉择。-2"><a href="#6-8-正确性与健壮性抉择。-2" class="headerlink" title="6.8 正确性与健壮性抉择。"></a>6.8 正确性与健壮性抉择。</h3><p>&amp;emsp;&amp;emsp;正确性意味着结果永远是正确的，如果出错，宁愿不给出结果也不要给定一个不准确的值。<br>&amp;emsp;&amp;emsp;健壮性意味着通过一些措施，保证软件能正常运行下去，即使有时候会有一些不准确的值出现。<br></br></p>
<h3 id="6-9-进攻式编程。-2"><a href="#6-9-进攻式编程。-2" class="headerlink" title="6.9 进攻式编程。"></a>6.9 进攻式编程。</h3><p>&amp;emsp;&amp;emsp;它的思想主要是提倡在开发阶段让问题尽可能显现出来，并且将问题扩大使得问题难以被忽视，这样才有助于问题不被忽视得到解决。而在产品运行时解决问题或让它能够自我纠正恢复。</p>
<h3 id="6-8-正确性与健壮性抉择。-3"><a href="#6-8-正确性与健壮性抉择。-3" class="headerlink" title="6.8 正确性与健壮性抉择。"></a>6.8 正确性与健壮性抉择。</h3><p>&amp;emsp;&amp;emsp;正确性意味着结果永远是正确的，如果出错，宁愿不给出结果也不要给定一个不准确的值。<br>&amp;emsp;&amp;emsp;健壮性意味着通过一些措施，保证软件能正常运行下去，即使有时候会有一些不准确的值出现。<br></br></p>
<h3 id="6-9-进攻式编程。-3"><a href="#6-9-进攻式编程。-3" class="headerlink" title="6.9 进攻式编程。"></a>6.9 进攻式编程。</h3><p>&amp;emsp;&amp;emsp;它的思想主要是提倡在开发阶段让问题尽可能显现出来，并且将问题扩大使得问题难以被忽视，这样才有助于问题不被忽视得到解决。而在产品运行时解决问题或让它能够自我纠正恢复。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://onlycalm.cn">OnlyCalm</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://onlycalm.cn/docs/%E7%BC%96%E7%A8%8B/%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3/%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C/">http://onlycalm.cn/docs/编程/编程思想/参数有效性检验/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://onlycalm.cn" target="_blank">OnlyCalm's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%A4%A7%E5%85%A8/">代码大全</a><a class="post-meta__tags" href="/tags/%E6%80%9D%E6%83%B3/">思想</a><a class="post-meta__tags" href="/tags/%E7%BC%96%E7%A8%8B/">编程</a></div><div class="post_share"><div class="social-share" data-image="https://onlycalm.gitee.io/blogimage/res/Cover_10.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="http://onlycalm.gitee.io/blogimage/res/微信收款码.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/res/微信收款码.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="http://onlycalm.gitee.io/blogimage/res/支付宝收款码.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/res/支付宝收款码.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/docs/%E5%B7%A5%E5%85%B7/GCC/%E5%9F%BA%E7%A1%80%E7%AF%87/%E6%B5%85%E6%98%BE%E6%98%93%E6%87%82%E7%9A%84GCC%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" title="浅显易懂的GCC使用教程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://onlycalm.gitee.io/blogimage/res/Cover_12.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">浅显易懂的GCC使用教程</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div class="comment-switch"><span class="first-comment">Valine</span><span id="switch-btn"></span><span class="second-comment">Gitalk</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://onlycalm.gitee.io/blogimage/res/Avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">OnlyCalm</div><div class="author-info__description">自娱自乐，做大娱乐家。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">229</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">327</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">53</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/onlycalm"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/onlycalm" target="_blank" title="GitHub"><i class="fab fa-github"></i></a><a class="social-icon" href="https://blog.csdn.net/qq_42475711" target="_blank" title="CSDN"><i class="fab fa-cuttlefish"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">贫富安。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C"><span class="toc-text">参数有效性检验</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="toc-text">1 问题：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%A3%80%E9%AA%8C%EF%BC%9F"><span class="toc-text">2 为什么要检验？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E5%88%A4%E4%B8%BA%E5%8F%82%E6%95%B0%E5%A4%B1%E6%95%88%EF%BC%9F"><span class="toc-text">3 哪些情况判为参数失效？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8F%82%E6%95%B0%E9%9C%80%E8%A6%81%E6%A3%80%E9%AA%8C%EF%BC%9F"><span class="toc-text">4 有哪些参数需要检验？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%8E%E4%B9%88%E6%A3%80%E6%B5%8B%EF%BC%9F"><span class="toc-text">5 怎么检测？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%8A%9F%E8%83%BD%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="toc-text">5.1 功能型参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%8A%B6%E6%80%81%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="toc-text">5.2 状态型参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%95%85%E9%9A%9C%E5%9E%8B%E5%8F%82%E6%95%B0%E3%80%82"><span class="toc-text">5.3 故障型参数。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%99%AE%E9%80%9A%E5%80%BC%E5%8F%82%E6%95%B0%E3%80%82"><span class="toc-text">5.4 普通值参数。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86%EF%BC%9F"><span class="toc-text">6 怎么处理？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%94%A8%E6%96%AD%E8%A8%80%E6%A3%80%E6%9F%A5%E6%B0%B8%E8%BF%9C%E4%B8%8D%E5%BA%94%E8%AF%A5%E5%8F%91%E7%94%9F%E7%9A%84%E9%94%99%E8%AF%AF"><span class="toc-text">6.1 用断言检查永远不应该发生的错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%BB%A3%E7%A0%81"><span class="toc-text">6.2 错误处理代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-%E8%BF%94%E5%9B%9E%E4%B8%AD%E7%AB%8B%E5%80%BC"><span class="toc-text">6.2.1 返回中立值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-%E7%BB%99%E5%87%BA%E4%B8%80%E4%B8%AA%E4%BF%AE%E6%AD%A3%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-text">6.2.2 给出一个修正的数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-3-%E6%8D%A2%E7%94%A8%E6%9C%80%E6%8E%A5%E8%BF%91%E7%9A%84%E5%90%88%E6%B3%95%E5%80%BC"><span class="toc-text">6.2.3 换用最接近的合法值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-4-%E6%8A%8A%E8%AD%A6%E5%91%8A%E4%BF%A1%E6%81%AF%E8%AE%B0%E5%BD%95%E5%88%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E4%B8%AD"><span class="toc-text">6.2.4 把警告信息记录到日志文件中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-5-%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E7%A0%81"><span class="toc-text">6.2.5 返回一个错误码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-6-%E8%B0%83%E7%94%A8%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%AD%90%E7%A8%8B%E5%BA%8F%E6%88%96%E5%AF%B9%E8%B1%A1"><span class="toc-text">6.2.6 调用错误处理子程序或对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-7-%E9%94%99%E8%AF%AF%E5%8F%91%E7%94%9F%E6%97%B6%E5%8F%91%E5%87%BA%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF"><span class="toc-text">6.2.7 错误发生时发出错误信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-8-%E5%9C%A8%E5%B1%80%E9%83%A8%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF"><span class="toc-text">6.2.8 在局部处理错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-9-%E5%85%B3%E9%97%AD%E6%88%96%E5%A4%8D%E4%BD%8D%E7%A8%8B%E5%BA%8F"><span class="toc-text">6.2.9 关闭或复位程序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%BC%82%E5%B8%B8"><span class="toc-text">6.3 异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E9%9A%94%E6%A0%8F"><span class="toc-text">6.4 隔栏</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C-1"><span class="toc-text">参数有效性检验</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%97%AE%E9%A2%98%EF%BC%9A-1"><span class="toc-text">1 问题：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%A3%80%E9%AA%8C%EF%BC%9F-1"><span class="toc-text">2 为什么要检验？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E5%88%A4%E4%B8%BA%E5%8F%82%E6%95%B0%E5%A4%B1%E6%95%88%EF%BC%9F-1"><span class="toc-text">3 哪些情况判为参数失效？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8F%82%E6%95%B0%E9%9C%80%E8%A6%81%E6%A3%80%E9%AA%8C%EF%BC%9F-1"><span class="toc-text">4 有哪些参数需要检验？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%8E%E4%B9%88%E6%A3%80%E6%B5%8B%EF%BC%9F-1"><span class="toc-text">5 怎么检测？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%8A%9F%E8%83%BD%E5%9E%8B%E5%8F%82%E6%95%B0-1"><span class="toc-text">5.1 功能型参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%8A%B6%E6%80%81%E5%9E%8B%E5%8F%82%E6%95%B0-1"><span class="toc-text">5.2 状态型参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%95%85%E9%9A%9C%E5%9E%8B%E5%8F%82%E6%95%B0%E3%80%82-1"><span class="toc-text">5.3 故障型参数。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%99%AE%E9%80%9A%E5%80%BC%E5%8F%82%E6%95%B0%E3%80%82-1"><span class="toc-text">5.4 普通值参数。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86%EF%BC%9F-1"><span class="toc-text">6 怎么处理？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%94%A8%E6%96%AD%E8%A8%80%E6%A3%80%E6%9F%A5%E6%B0%B8%E8%BF%9C%E4%B8%8D%E5%BA%94%E8%AF%A5%E5%8F%91%E7%94%9F%E7%9A%84%E9%94%99%E8%AF%AF-1"><span class="toc-text">6.1 用断言检查永远不应该发生的错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%BB%A3%E7%A0%81-1"><span class="toc-text">6.2 错误处理代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-%E8%BF%94%E5%9B%9E%E4%B8%AD%E7%AB%8B%E5%80%BC-1"><span class="toc-text">6.2.1 返回中立值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-%E7%BB%99%E5%87%BA%E4%B8%80%E4%B8%AA%E4%BF%AE%E6%AD%A3%E7%9A%84%E6%95%B0%E6%8D%AE-1"><span class="toc-text">6.2.2 给出一个修正的数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-3-%E6%8D%A2%E7%94%A8%E6%9C%80%E6%8E%A5%E8%BF%91%E7%9A%84%E5%90%88%E6%B3%95%E5%80%BC-1"><span class="toc-text">6.2.3 换用最接近的合法值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-4-%E6%8A%8A%E8%AD%A6%E5%91%8A%E4%BF%A1%E6%81%AF%E8%AE%B0%E5%BD%95%E5%88%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E4%B8%AD-1"><span class="toc-text">6.2.4 把警告信息记录到日志文件中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-5-%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E7%A0%81-1"><span class="toc-text">6.2.5 返回一个错误码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-6-%E8%B0%83%E7%94%A8%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%AD%90%E7%A8%8B%E5%BA%8F%E6%88%96%E5%AF%B9%E8%B1%A1-1"><span class="toc-text">6.2.6 调用错误处理子程序或对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-7-%E9%94%99%E8%AF%AF%E5%8F%91%E7%94%9F%E6%97%B6%E5%8F%91%E5%87%BA%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF-1"><span class="toc-text">6.2.7 错误发生时发出错误信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-8-%E5%9C%A8%E5%B1%80%E9%83%A8%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF-1"><span class="toc-text">6.2.8 在局部处理错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-9-%E5%85%B3%E9%97%AD%E6%88%96%E5%A4%8D%E4%BD%8D%E7%A8%8B%E5%BA%8F-1"><span class="toc-text">6.2.9 关闭或复位程序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%BC%82%E5%B8%B8-1"><span class="toc-text">6.3 异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E9%9A%94%E6%A0%8F-1"><span class="toc-text">6.4 隔栏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86%E3%80%82"><span class="toc-text">6.5 错误日志处理。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-1-%E6%97%A5%E5%BF%97%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">6.5.1 日志的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-2-%E5%A6%82%E4%BD%95%E5%81%9A%E5%A5%BD%E7%A8%8B%E5%BA%8F%E6%97%A5%E5%BF%97"><span class="toc-text">6.5.2 如何做好程序日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E9%94%99%E8%AF%AF%E7%A0%81"><span class="toc-text">6.6 错误码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E8%B0%83%E8%AF%95log"><span class="toc-text">6.7 调试log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-%E6%AD%A3%E7%A1%AE%E6%80%A7%E4%B8%8E%E5%81%A5%E5%A3%AE%E6%80%A7%E6%8A%89%E6%8B%A9%E3%80%82"><span class="toc-text">6.8 正确性与健壮性抉择。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-9-%E8%BF%9B%E6%94%BB%E5%BC%8F%E7%BC%96%E7%A8%8B%E3%80%82"><span class="toc-text">6.9 进攻式编程。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86%E3%80%82-1"><span class="toc-text">6.5 错误日志处理。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-1-%E6%97%A5%E5%BF%97%E7%9A%84%E4%BD%9C%E7%94%A8-1"><span class="toc-text">6.5.1 日志的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-2-%E5%A6%82%E4%BD%95%E5%81%9A%E5%A5%BD%E7%A8%8B%E5%BA%8F%E6%97%A5%E5%BF%97-1"><span class="toc-text">6.5.2 如何做好程序日志</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C-2"><span class="toc-text">参数有效性检验</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%97%AE%E9%A2%98%EF%BC%9A-2"><span class="toc-text">1 问题：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%A3%80%E9%AA%8C%EF%BC%9F-2"><span class="toc-text">2 为什么要检验？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E5%88%A4%E4%B8%BA%E5%8F%82%E6%95%B0%E5%A4%B1%E6%95%88%EF%BC%9F-2"><span class="toc-text">3 哪些情况判为参数失效？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8F%82%E6%95%B0%E9%9C%80%E8%A6%81%E6%A3%80%E9%AA%8C%EF%BC%9F-2"><span class="toc-text">4 有哪些参数需要检验？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%8E%E4%B9%88%E6%A3%80%E6%B5%8B%EF%BC%9F-2"><span class="toc-text">5 怎么检测？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%8A%9F%E8%83%BD%E5%9E%8B%E5%8F%82%E6%95%B0-2"><span class="toc-text">5.1 功能型参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%8A%B6%E6%80%81%E5%9E%8B%E5%8F%82%E6%95%B0-2"><span class="toc-text">5.2 状态型参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%95%85%E9%9A%9C%E5%9E%8B%E5%8F%82%E6%95%B0%E3%80%82-2"><span class="toc-text">5.3 故障型参数。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%99%AE%E9%80%9A%E5%80%BC%E5%8F%82%E6%95%B0%E3%80%82-2"><span class="toc-text">5.4 普通值参数。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86%EF%BC%9F-2"><span class="toc-text">6 怎么处理？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%94%A8%E6%96%AD%E8%A8%80%E6%A3%80%E6%9F%A5%E6%B0%B8%E8%BF%9C%E4%B8%8D%E5%BA%94%E8%AF%A5%E5%8F%91%E7%94%9F%E7%9A%84%E9%94%99%E8%AF%AF-2"><span class="toc-text">6.1 用断言检查永远不应该发生的错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%BB%A3%E7%A0%81-2"><span class="toc-text">6.2 错误处理代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-%E8%BF%94%E5%9B%9E%E4%B8%AD%E7%AB%8B%E5%80%BC-2"><span class="toc-text">6.2.1 返回中立值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-%E7%BB%99%E5%87%BA%E4%B8%80%E4%B8%AA%E4%BF%AE%E6%AD%A3%E7%9A%84%E6%95%B0%E6%8D%AE-2"><span class="toc-text">6.2.2 给出一个修正的数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-3-%E6%8D%A2%E7%94%A8%E6%9C%80%E6%8E%A5%E8%BF%91%E7%9A%84%E5%90%88%E6%B3%95%E5%80%BC-2"><span class="toc-text">6.2.3 换用最接近的合法值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-4-%E6%8A%8A%E8%AD%A6%E5%91%8A%E4%BF%A1%E6%81%AF%E8%AE%B0%E5%BD%95%E5%88%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E4%B8%AD-2"><span class="toc-text">6.2.4 把警告信息记录到日志文件中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-5-%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E7%A0%81-2"><span class="toc-text">6.2.5 返回一个错误码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-6-%E8%B0%83%E7%94%A8%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%AD%90%E7%A8%8B%E5%BA%8F%E6%88%96%E5%AF%B9%E8%B1%A1-2"><span class="toc-text">6.2.6 调用错误处理子程序或对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-7-%E9%94%99%E8%AF%AF%E5%8F%91%E7%94%9F%E6%97%B6%E5%8F%91%E5%87%BA%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF-2"><span class="toc-text">6.2.7 错误发生时发出错误信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-8-%E5%9C%A8%E5%B1%80%E9%83%A8%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF-2"><span class="toc-text">6.2.8 在局部处理错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-9-%E5%85%B3%E9%97%AD%E6%88%96%E5%A4%8D%E4%BD%8D%E7%A8%8B%E5%BA%8F-2"><span class="toc-text">6.2.9 关闭或复位程序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%BC%82%E5%B8%B8-2"><span class="toc-text">6.3 异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E9%9A%94%E6%A0%8F-2"><span class="toc-text">6.4 隔栏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86%E3%80%82-2"><span class="toc-text">6.5 错误日志处理。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-1-%E6%97%A5%E5%BF%97%E7%9A%84%E4%BD%9C%E7%94%A8-2"><span class="toc-text">6.5.1 日志的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-2-%E5%A6%82%E4%BD%95%E5%81%9A%E5%A5%BD%E7%A8%8B%E5%BA%8F%E6%97%A5%E5%BF%97-2"><span class="toc-text">6.5.2 如何做好程序日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E9%94%99%E8%AF%AF%E7%A0%81-1"><span class="toc-text">6.6 错误码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E8%B0%83%E8%AF%95log-1"><span class="toc-text">6.7 调试log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-%E6%AD%A3%E7%A1%AE%E6%80%A7%E4%B8%8E%E5%81%A5%E5%A3%AE%E6%80%A7%E6%8A%89%E6%8B%A9%E3%80%82-1"><span class="toc-text">6.8 正确性与健壮性抉择。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-9-%E8%BF%9B%E6%94%BB%E5%BC%8F%E7%BC%96%E7%A8%8B%E3%80%82-1"><span class="toc-text">6.9 进攻式编程。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E9%94%99%E8%AF%AF%E7%A0%81-2"><span class="toc-text">6.6 错误码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E8%B0%83%E8%AF%95log-2"><span class="toc-text">6.7 调试log</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E9%AA%8C-3"><span class="toc-text">参数有效性检验</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%97%AE%E9%A2%98%EF%BC%9A-3"><span class="toc-text">1 问题：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%A3%80%E9%AA%8C%EF%BC%9F-3"><span class="toc-text">2 为什么要检验？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E5%88%A4%E4%B8%BA%E5%8F%82%E6%95%B0%E5%A4%B1%E6%95%88%EF%BC%9F-3"><span class="toc-text">3 哪些情况判为参数失效？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9C%89%E5%93%AA%E4%BA%9B%E5%8F%82%E6%95%B0%E9%9C%80%E8%A6%81%E6%A3%80%E9%AA%8C%EF%BC%9F-3"><span class="toc-text">4 有哪些参数需要检验？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%8E%E4%B9%88%E6%A3%80%E6%B5%8B%EF%BC%9F-3"><span class="toc-text">5 怎么检测？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%8A%9F%E8%83%BD%E5%9E%8B%E5%8F%82%E6%95%B0-3"><span class="toc-text">5.1 功能型参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%8A%B6%E6%80%81%E5%9E%8B%E5%8F%82%E6%95%B0-3"><span class="toc-text">5.2 状态型参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%95%85%E9%9A%9C%E5%9E%8B%E5%8F%82%E6%95%B0%E3%80%82-3"><span class="toc-text">5.3 故障型参数。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%99%AE%E9%80%9A%E5%80%BC%E5%8F%82%E6%95%B0%E3%80%82-3"><span class="toc-text">5.4 普通值参数。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86%EF%BC%9F-3"><span class="toc-text">6 怎么处理？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%94%A8%E6%96%AD%E8%A8%80%E6%A3%80%E6%9F%A5%E6%B0%B8%E8%BF%9C%E4%B8%8D%E5%BA%94%E8%AF%A5%E5%8F%91%E7%94%9F%E7%9A%84%E9%94%99%E8%AF%AF-3"><span class="toc-text">6.1 用断言检查永远不应该发生的错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%BB%A3%E7%A0%81-3"><span class="toc-text">6.2 错误处理代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-%E8%BF%94%E5%9B%9E%E4%B8%AD%E7%AB%8B%E5%80%BC-3"><span class="toc-text">6.2.1 返回中立值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-%E7%BB%99%E5%87%BA%E4%B8%80%E4%B8%AA%E4%BF%AE%E6%AD%A3%E7%9A%84%E6%95%B0%E6%8D%AE-3"><span class="toc-text">6.2.2 给出一个修正的数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-3-%E6%8D%A2%E7%94%A8%E6%9C%80%E6%8E%A5%E8%BF%91%E7%9A%84%E5%90%88%E6%B3%95%E5%80%BC-3"><span class="toc-text">6.2.3 换用最接近的合法值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-4-%E6%8A%8A%E8%AD%A6%E5%91%8A%E4%BF%A1%E6%81%AF%E8%AE%B0%E5%BD%95%E5%88%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E4%B8%AD-3"><span class="toc-text">6.2.4 把警告信息记录到日志文件中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-5-%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E7%A0%81-3"><span class="toc-text">6.2.5 返回一个错误码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-6-%E8%B0%83%E7%94%A8%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%AD%90%E7%A8%8B%E5%BA%8F%E6%88%96%E5%AF%B9%E8%B1%A1-3"><span class="toc-text">6.2.6 调用错误处理子程序或对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-7-%E9%94%99%E8%AF%AF%E5%8F%91%E7%94%9F%E6%97%B6%E5%8F%91%E5%87%BA%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF-3"><span class="toc-text">6.2.7 错误发生时发出错误信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-8-%E5%9C%A8%E5%B1%80%E9%83%A8%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF-3"><span class="toc-text">6.2.8 在局部处理错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-9-%E5%85%B3%E9%97%AD%E6%88%96%E5%A4%8D%E4%BD%8D%E7%A8%8B%E5%BA%8F-3"><span class="toc-text">6.2.9 关闭或复位程序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%BC%82%E5%B8%B8-3"><span class="toc-text">6.3 异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E9%9A%94%E6%A0%8F-3"><span class="toc-text">6.4 隔栏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86%E3%80%82-3"><span class="toc-text">6.5 错误日志处理。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-1-%E6%97%A5%E5%BF%97%E7%9A%84%E4%BD%9C%E7%94%A8-3"><span class="toc-text">6.5.1 日志的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-2-%E5%A6%82%E4%BD%95%E5%81%9A%E5%A5%BD%E7%A8%8B%E5%BA%8F%E6%97%A5%E5%BF%97-3"><span class="toc-text">6.5.2 如何做好程序日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E9%94%99%E8%AF%AF%E7%A0%81-3"><span class="toc-text">6.6 错误码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E8%B0%83%E8%AF%95log-3"><span class="toc-text">6.7 调试log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-%E6%AD%A3%E7%A1%AE%E6%80%A7%E4%B8%8E%E5%81%A5%E5%A3%AE%E6%80%A7%E6%8A%89%E6%8B%A9%E3%80%82-2"><span class="toc-text">6.8 正确性与健壮性抉择。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-9-%E8%BF%9B%E6%94%BB%E5%BC%8F%E7%BC%96%E7%A8%8B%E3%80%82-2"><span class="toc-text">6.9 进攻式编程。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-%E6%AD%A3%E7%A1%AE%E6%80%A7%E4%B8%8E%E5%81%A5%E5%A3%AE%E6%80%A7%E6%8A%89%E6%8B%A9%E3%80%82-3"><span class="toc-text">6.8 正确性与健壮性抉择。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-9-%E8%BF%9B%E6%94%BB%E5%BC%8F%E7%BC%96%E7%A8%8B%E3%80%82-3"><span class="toc-text">6.9 进攻式编程。</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/docs/%E5%B7%A5%E5%85%B7/Hexo/%E8%87%AA%E5%A8%B1%E8%87%AA%E4%B9%90%EF%BC%8C%E6%88%91%E7%9A%84%E5%8D%9A%E5%AE%A2%EF%BC%88%E5%8D%81%E4%B8%83%EF%BC%89%E2%80%94%E2%80%94%E8%85%BE%E8%AE%AF%E4%BA%91SSL%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7/" title="自娱自乐，我的博客（十七）——腾讯云SSL证书申请"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://onlycalm.gitee.io/blogimage/res/Cover_3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="自娱自乐，我的博客（十七）——腾讯云SSL证书申请"/></a><div class="content"><a class="title" href="/docs/%E5%B7%A5%E5%85%B7/Hexo/%E8%87%AA%E5%A8%B1%E8%87%AA%E4%B9%90%EF%BC%8C%E6%88%91%E7%9A%84%E5%8D%9A%E5%AE%A2%EF%BC%88%E5%8D%81%E4%B8%83%EF%BC%89%E2%80%94%E2%80%94%E8%85%BE%E8%AE%AF%E4%BA%91SSL%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7/" title="自娱自乐，我的博客（十七）——腾讯云SSL证书申请">自娱自乐，我的博客（十七）——腾讯云SSL证书申请</a><time datetime="2024-02-06T06:08:00.000Z" title="发表于 2024-02-06 14:08:00">2024-02-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/docs/%E5%B7%A5%E5%85%B7/Hexo/%E8%87%AA%E5%A8%B1%E8%87%AA%E4%B9%90%EF%BC%8C%E6%88%91%E7%9A%84%E5%8D%9A%E5%AE%A2%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89%E2%80%94%E2%80%94%E5%8D%9A%E5%AE%A2%E6%89%98%E7%AE%A1%E5%88%B0%E8%85%BE%E8%AE%AF%E4%BA%91/" title="自娱自乐，我的博客（十六）——博客托管到腾讯云"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://onlycalm.gitee.io/blogimage/res/Cover_9.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="自娱自乐，我的博客（十六）——博客托管到腾讯云"/></a><div class="content"><a class="title" href="/docs/%E5%B7%A5%E5%85%B7/Hexo/%E8%87%AA%E5%A8%B1%E8%87%AA%E4%B9%90%EF%BC%8C%E6%88%91%E7%9A%84%E5%8D%9A%E5%AE%A2%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89%E2%80%94%E2%80%94%E5%8D%9A%E5%AE%A2%E6%89%98%E7%AE%A1%E5%88%B0%E8%85%BE%E8%AE%AF%E4%BA%91/" title="自娱自乐，我的博客（十六）——博客托管到腾讯云">自娱自乐，我的博客（十六）——博客托管到腾讯云</a><time datetime="2024-02-06T03:43:00.000Z" title="发表于 2024-02-06 11:43:00">2024-02-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/docs/%E5%B7%A5%E5%85%B7/Hexo/%E8%87%AA%E5%A8%B1%E8%87%AA%E4%B9%90%EF%BC%8C%E6%88%91%E7%9A%84%E5%8D%9A%E5%AE%A2%EF%BC%88%E5%8D%81%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94%E5%9F%9F%E5%90%8DICP%E5%A4%87%E6%A1%88/" title="自娱自乐，我的博客（十五）——域名ICP备案"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://onlycalm.gitee.io/blogimage/res/Cover_11.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="自娱自乐，我的博客（十五）——域名ICP备案"/></a><div class="content"><a class="title" href="/docs/%E5%B7%A5%E5%85%B7/Hexo/%E8%87%AA%E5%A8%B1%E8%87%AA%E4%B9%90%EF%BC%8C%E6%88%91%E7%9A%84%E5%8D%9A%E5%AE%A2%EF%BC%88%E5%8D%81%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94%E5%9F%9F%E5%90%8DICP%E5%A4%87%E6%A1%88/" title="自娱自乐，我的博客（十五）——域名ICP备案">自娱自乐，我的博客（十五）——域名ICP备案</a><time datetime="2024-02-05T11:37:00.000Z" title="发表于 2024-02-05 19:37:00">2024-02-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/docs/%E5%B7%A5%E5%85%B7/Ubuntu/Ubuntu20.04%E5%AE%89%E8%A3%85qq%E9%9F%B3%E4%B9%90/" title="Ubuntu20.04安装qq音乐"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://onlycalm.gitee.io/blogimage/res/Cover_7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ubuntu20.04安装qq音乐"/></a><div class="content"><a class="title" href="/docs/%E5%B7%A5%E5%85%B7/Ubuntu/Ubuntu20.04%E5%AE%89%E8%A3%85qq%E9%9F%B3%E4%B9%90/" title="Ubuntu20.04安装qq音乐">Ubuntu20.04安装qq音乐</a><time datetime="2024-02-04T15:38:00.000Z" title="发表于 2024-02-04 23:38:00">2024-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/docs/%E5%B7%A5%E5%85%B7/Vim/%E5%9F%BA%E7%A1%80%E7%AF%87/Vim%E5%9F%BA%E7%A1%80%E7%AF%87%EF%BC%88%E4%BA%8C%E5%8D%81%E5%85%AB%EF%BC%89%E2%80%94%E2%80%94%E7%BB%88%E7%AB%AF%E6%8F%92%E4%BB%B6vim-floaterm/" title="Vim基础篇（二十八）——终端插件vim-floaterm"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://onlycalm.gitee.io/blogimage/res/Cover_13.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vim基础篇（二十八）——终端插件vim-floaterm"/></a><div class="content"><a class="title" href="/docs/%E5%B7%A5%E5%85%B7/Vim/%E5%9F%BA%E7%A1%80%E7%AF%87/Vim%E5%9F%BA%E7%A1%80%E7%AF%87%EF%BC%88%E4%BA%8C%E5%8D%81%E5%85%AB%EF%BC%89%E2%80%94%E2%80%94%E7%BB%88%E7%AB%AF%E6%8F%92%E4%BB%B6vim-floaterm/" title="Vim基础篇（二十八）——终端插件vim-floaterm">Vim基础篇（二十八）——终端插件vim-floaterm</a><time datetime="2023-01-20T12:05:00.000Z" title="发表于 2023-01-20 20:05:00">2023-01-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By OnlyCalm</div><div class="footer_custom_text">生生灯火，明暗无辄</br>欢迎访问 <a href="https://onlycalm.cn">OnlyCalm</a> 的博客</br>粤ICP备2024183071号-1</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? '' : ''

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'uoaDTvEN4KnsU5xM1f2l1T12-MdYXbMMI',
      appKey: 'f2158LsoEVzRzMS8EG7rvFSs',
      avatar: 'wavatar',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: '0b3f5b76c03e1d9ecca0',
      clientSecret: '94ba0623c1599038f16bc6ecbdf0c9015c735fe5',
      repo: 'blogtalk',
      owner: 'onlycalm',
      admin: ['onlycalm'],
      id: '605500532a526ca20c7460cfd1a0f2ad',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Valine' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script src="/js/sakura.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/unitychan.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body></html>